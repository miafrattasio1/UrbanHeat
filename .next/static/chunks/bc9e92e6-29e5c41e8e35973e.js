"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[992],{4150:(e,t,r)=>{r.d(t,{aU:()=>oQ});var n,i,s,a,o=r(1972),l=r(7086),u=r(4075),h=r(6959),c=r(7898),d=r(426),f=r(2818),m=r(5714).Buffer;let g="@firebase/firestore",p="4.7.9";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="11.4.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function T(e,...t){if(v.logLevel<=u.$b.DEBUG){let r=t.map(_);v.debug(`Firestore (${w}): ${e}`,...r)}}function E(e,...t){if(v.logLevel<=u.$b.ERROR){let r=t.map(_);v.error(`Firestore (${w}): ${e}`,...r)}}function b(e,...t){if(v.logLevel<=u.$b.WARN){let r=t.map(_);v.warn(`Firestore (${w}): ${e}`,...r)}}function _(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function x(e="Unexpected state"){let t=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: `+e;throw E(t),Error(t)}let S={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class N extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class k{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class D{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class C{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class A{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class V{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){void 0===this.o||x();let r=this.i,n=e=>this.i!==r?(r=this.i,t(e)):Promise.resolve(),i=new k;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new k,e.enqueueRetryable(()=>n(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await n(this.currentUser)})},a=e=>{T("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(T("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new k)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(T("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?("string"==typeof t.accessToken||x(),new D(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return null===e||"string"==typeof e||x(),new y(e)}}class R{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=y.FIRST_PARTY,this.T=new Map}I(){return this.P?this.P():null}get headers(){this.T.set("X-Goog-AuthUser",this.l);let e=this.I();return e&&this.T.set("Authorization",e),this.h&&this.T.set("X-Goog-Iam-Authorization-Token",this.h),this.T}}class O{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new R(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class M{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e,t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null,this.V=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.V=e.settings.appCheckToken)}start(e,t){void 0===this.o||x();let r=e=>{null!=e.error&&T("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let r=e.token!==this.R;return this.R=e.token,T("FirebaseAppCheckTokenProvider",`Received ${r?"new":"existing"} token.`),r?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>r(t))};let n=e=>{T("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>n(e)),setTimeout(()=>{if(!this.appCheck){let e=this.A.getImmediate({optional:!0});e?n(e):T("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.V)return Promise.resolve(new M(this.V));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?("string"==typeof e.token||x(),this.R=e.token,new M(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class F{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let r=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),r=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(r);else for(let e=0;e<40;e++)r[e]=Math.floor(256*Math.random());return r}(0);for(let n=0;n<r.length;++n)t.length<20&&r[n]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(r[n]%62))}return t}}function P(e,t){return e<t?-1:e>t?1:0}function U(e,t,r){return e.length===t.length&&e.every((e,n)=>r(e,t[n]))}class q{static now(){return q.fromMillis(Date.now())}static fromDate(e){return q.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor((e-1e3*t)*1e6);return new q(t,r)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new N(S.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new N(S.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?P(this.nanoseconds,e.nanoseconds):P(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{static fromTimestamp(e){return new B(e)}static min(){return new B(new q(0,0))}static max(){return new B(new q(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}let K="__name__";class z{constructor(e,t,r){void 0===t?t=0:t>e.length&&x(),void 0===r?r=e.length-t:r>e.length-t&&x(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return 0===z.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof z?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let n=0;n<r;n++){let r=z.compareSegments(e.get(n),t.get(n));if(0!==r)return r}return Math.sign(e.length-t.length)}static compareSegments(e,t){let r=z.isNumericId(e),n=z.isNumericId(t);return r&&!n?-1:!r&&n?1:r&&n?z.extractNumericId(e).compare(z.extractNumericId(t)):e<t?-1:e>t?1:0}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return c.jz.fromString(e.substring(4,e.length-2))}}class $ extends z{construct(e,t,r){return new $(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new N(S.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(e=>e.length>0))}return new $(t)}static emptyPath(){return new $([])}}let G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class j extends z{construct(e,t,r){return new j(e,t,r)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),j.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===K}static keyField(){return new j([K])}static fromServerFormat(e){let t=[],r="",n=0,i=()=>{if(0===r.length)throw new N(S.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},s=!1;for(;n<e.length;){let t=e[n];if("\\"===t){if(n+1===e.length)throw new N(S.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[n+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new N(S.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=t,n+=2}else"`"===t?s=!s:"."!==t||s?r+=t:i(),n++}if(i(),s)throw new N(S.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new j(t)}static emptyPath(){return new j([])}}class Q{constructor(e){this.path=e}static fromPath(e){return new Q($.fromString(e))}static fromName(e){return new Q($.fromString(e).popFirst(5))}static empty(){return new Q($.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===$.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return $.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new Q(new $(e.slice()))}}class H{constructor(e,t,r,n){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=n}}function W(e){return e.fields.find(e=>2===e.kind)}function Y(e){return e.fields.filter(e=>2!==e.kind)}H.UNKNOWN_ID=-1;class Z{constructor(e,t){this.fieldPath=e,this.kind=t}}class J{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new J(0,et.min())}}function X(e,t){let r=e.toTimestamp().seconds,n=e.toTimestamp().nanoseconds+1;return new et(B.fromTimestamp(1e9===n?new q(r+1,0):new q(r,n)),Q.empty(),t)}function ee(e){return new et(e.readTime,e.key,-1)}class et{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new et(B.min(),Q.empty(),-1)}static max(){return new et(B.max(),Q.empty(),-1)}}function er(e,t){let r=e.readTime.compareTo(t.readTime);return 0!==r?r:0!==(r=Q.comparator(e.documentKey,t.documentKey))?r:P(e.largestBatchId,t.largestBatchId)}let en="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ei{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function es(e){if(e.code!==S.FAILED_PRECONDITION||e.message!==en)throw e;T("LocalStore","Unexpectedly lost primary lease")}class ea{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&x(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ea((r,n)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(r,n)},this.catchCallback=e=>{this.wrapFailure(t,e).next(r,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ea?t:ea.resolve(t)}catch(e){return ea.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ea.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ea.reject(t)}static resolve(e){return new ea((t,r)=>{t(e)})}static reject(e){return new ea((t,r)=>{r(e)})}static waitFor(e){return new ea((t,r)=>{let n=0,i=0,s=!1;e.forEach(e=>{++n,e.next(()=>{++i,s&&i===n&&t()},e=>r(e))}),s=!0,i===n&&t()})}static or(e){let t=ea.resolve(!1);for(let r of e)t=t.next(e=>e?ea.resolve(e):r());return t}static forEach(e,t){let r=[];return e.forEach((e,n)=>{r.push(t.call(this,e,n))}),this.waitFor(r)}static mapArray(e,t){return new ea((r,n)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&r(s)},e=>n(e))}})}static doWhile(e,t){return new ea((r,n)=>{let i=()=>{!0===e()?t().next(()=>{i()},n):r()};i()})}}let eo="SimpleDb";class el{static open(e,t,r,n){try{return new el(t,e.transaction(n,r))}catch(e){throw new ed(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.m=new k,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{t.error?this.m.reject(new ed(e,t.error)):this.m.resolve()},this.transaction.onerror=t=>{let r=ey(t.target.error);this.m.reject(new ed(e,r))}}get p(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(T(eo,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}S(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new em(this.transaction.objectStore(e))}}class eu{static delete(e){return T(eo,"Removing database:",e),eg(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,h.zW)())return!1;if(eu.v())return!0;let e=(0,h.ZQ)(),t=eu.C(e),r=eh(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<r&&r<4.5)}static v(){var e;return void 0!==f&&"YES"===(null===(e=f.__PRIVATE_env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static C(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,r){this.name=e,this.version=t,this.O=r,12.2===eu.C((0,h.ZQ)())&&E("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async N(e){return this.db||(T(eo,"Opening database:",this.name),this.db=await new Promise((t,r)=>{let n=indexedDB.open(this.name,this.version);n.onsuccess=e=>{t(e.target.result)},n.onblocked=()=>{r(new ed(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},n.onerror=t=>{let n=t.target.error;"VersionError"===n.name?r(new N(S.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===n.name?r(new N(S.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+n)):r(new ed(e,n))},n.onupgradeneeded=e=>{T(eo,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.O.B(t,n.transaction,e.oldVersion,this.version).next(()=>{T(eo,"Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(e){this.L=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,r,n){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.N(e);let t=el.open(this.db,e,i?"readonly":"readwrite",r),s=n(t).next(e=>(t.S(),e)).catch(e=>(t.abort(e),ea.reject(e))).toPromise();return s.catch(()=>{}),await t.p,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(T(eo,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eh(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class ec{constructor(e){this.q=e,this.$=!1,this.K=null}get isDone(){return this.$}get U(){return this.K}set cursor(e){this.q=e}done(){this.$=!0}W(e){this.K=e}delete(){return eg(this.q.delete())}}class ed extends N{constructor(e,t){super(S.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ef(e){return"IndexedDbTransactionError"===e.name}class em{constructor(e){this.store=e}put(e,t){let r;return void 0!==t?(T(eo,"PUT",this.store.name,e,t),r=this.store.put(t,e)):(T(eo,"PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),eg(r)}add(e){return T(eo,"ADD",this.store.name,e,e),eg(this.store.add(e))}get(e){return eg(this.store.get(e)).next(t=>(void 0===t&&(t=null),T(eo,"GET",this.store.name,e,t),t))}delete(e){return T(eo,"DELETE",this.store.name,e),eg(this.store.delete(e))}count(){return T(eo,"COUNT",this.store.name),eg(this.store.count())}G(e,t){let r=this.options(e,t),n=r.index?this.store.index(r.index):this.store;if("function"==typeof n.getAll){let e=n.getAll(r.range);return new ea((t,r)=>{e.onerror=e=>{r(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(r),t=[];return this.j(e,(e,r)=>{t.push(r)}).next(()=>t)}}H(e,t){let r=this.store.getAll(e,null===t?void 0:t);return new ea((e,t)=>{r.onerror=e=>{t(e.target.error)},r.onsuccess=t=>{e(t.target.result)}})}J(e,t){T(eo,"DELETE ALL",this.store.name);let r=this.options(e,t);r.Y=!1;let n=this.cursor(r);return this.j(n,(e,t,r)=>r.delete())}Z(e,t){let r;t?r=e:(r={},t=e);let n=this.cursor(r);return this.j(n,t)}X(e){let t=this.cursor({});return new ea((r,n)=>{t.onerror=e=>{n(ey(e.target.error))},t.onsuccess=t=>{let n=t.target.result;n?e(n.primaryKey,n.value).next(e=>{e?n.continue():r()}):r()}})}j(e,t){let r=[];return new ea((n,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void n();let s=new ec(i),a=t(i.primaryKey,i.value,s);if(a instanceof ea){let e=a.catch(e=>(s.done(),ea.reject(e)));r.push(e)}s.isDone?n():null===s.U?i.continue():i.continue(s.U)}}).next(()=>ea.waitFor(r))}options(e,t){let r;return void 0!==e&&("string"==typeof e?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.Y?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eg(e){return new ea((t,r)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{r(ey(e.target.error))}})}let ep=!1;function ey(e){let t=eu.C((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new N("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ep||(ep=!0,setTimeout(()=>{throw e},0)),e}}return e}let ew="IndexBackfiller";class ev{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){T(ew,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ee.ne();T(ew,`Documents written: ${e}`)}catch(e){ef(e)?T(ew,"Ignoring IndexedDB error during index backfill: ",e):await es(e)}await this.te(6e4)})}}class eI{constructor(e,t){this.localStore=e,this.persistence=t}async ne(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.re(t,e))}re(e,t){let r=new Set,n=t,i=!0;return ea.doWhile(()=>!0===i&&n>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!r.has(t))return T(ew,`Processing collection: ${t}`),this.ie(e,t,n).next(e=>{n-=e,r.add(t)});i=!1})).next(()=>t-n)}ie(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(n=>this.localStore.localDocuments.getNextDocuments(e,t,n,r).next(r=>{let i=r.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.se(n,r)).next(r=>(T(ew,`Updating offset: ${r}`),this.localStore.indexManager.updateCollectionGroup(e,t,r))).next(()=>i.size)}))}se(e,t){let r=e;return t.changes.forEach((e,t)=>{let n=ee(t);er(n,r)>0&&(r=n)}),new et(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eT{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this._e&&this._e(e),e}}function eE(e){return null==e}function eb(e){return 0===e&&1/e==-1/0}function e_(e){return"number"==typeof e&&Number.isInteger(e)&&!eb(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function ex(e){let t="";for(let r=0;r<e.length;r++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let r=t,n=e.length;for(let t=0;t<n;t++){let n=e.charAt(t);switch(n){case"\0":r+="\x01\x10";break;case"\x01":r+="\x01\x11";break;default:r+=n}}return r}(e.get(r),t);return t+"\x01\x01"}function eS(e){let t=e.length;if(t>=2||x(),2===t)return"\x01"===e.charAt(0)&&"\x01"===e.charAt(1)||x(),$.emptyPath();let r=t-2,n=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>r)&&x(),e.charAt(t+1)){case"\x01":let a;let o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),n.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:x()}s=t+2}return new $(n)}eT.ae=-1;let eN="remoteDocuments",ek="owner",eD="owner",eC="mutationQueues",eA="mutations",eV="batchId",eR="userMutationsIndex",eO=["userId","batchId"],eM={},eL="documentMutations",eF="remoteDocumentsV14",eP=["prefixPath","collectionGroup","readTime","documentId"],eU="documentKeyIndex",eq=["prefixPath","collectionGroup","documentId"],eB="collectionGroupIndex",eK=["collectionGroup","readTime","prefixPath","documentId"],ez="remoteDocumentGlobal",e$="remoteDocumentGlobalKey",eG="targets",ej="queryTargetsIndex",eQ=["canonicalId","targetId"],eH="targetDocuments",eW=["targetId","path"],eY="documentTargetsIndex",eZ=["path","targetId"],eJ="targetGlobalKey",eX="targetGlobal",e0="collectionParents",e1=["collectionId","parent"],e2="clientMetadata",e5="bundles",e8="namedQueries",e4="indexConfiguration",e3="collectionGroupIndex",e6="indexState",e9=["indexId","uid"],e7="sequenceNumberIndex",te=["uid","sequenceNumber"],tt="indexEntries",tr=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tn="documentKeyIndex",ti=["indexId","uid","orderedDocumentKey"],ts="documentOverlays",ta=["userId","collectionPath","documentId"],to="collectionPathOverlayIndex",tl=["userId","collectionPath","largestBatchId"],tu="collectionGroupOverlayIndex",th=["userId","collectionGroup","largestBatchId"],tc="globals",td=[eC,eA,eL,eN,eG,ek,eX,eH,e2,ez,e0,e5,e8],tf=[...td,ts],tm=[eC,eA,eL,eF,eG,ek,eX,eH,e2,ez,e0,e5,e8,ts],tg=[...tm,e4,e6,tt],tp=[...tg,tc];class ty extends ei{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function tw(e,t){return eu.M(e.ue,t)}function tv(e){let t=0;for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t++;return t}function tI(e,t){for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(r,e[r])}function tT(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tE{constructor(e,t){this.comparator=e,this.root=t||t_.EMPTY}insert(e,t){return new tE(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,t_.BLACK,null,null))}remove(e){return new tE(this.comparator,this.root.remove(e,this.comparator).copy(null,null,t_.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(0===r)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let n=this.comparator(e,r.key);if(0===n)return t+r.left.size;n<0?r=r.left:(t+=r.left.size+1,r=r.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tb(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tb(this.root,e,this.comparator,!1)}getReverseIterator(){return new tb(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tb(this.root,e,this.comparator,!0)}}class tb{constructor(e,t,r,n){this.isReverse=n,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?r(e.key,t):1,t&&n&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class t_{constructor(e,t,r,n,i){this.key=e,this.value=t,this.color=null!=r?r:t_.RED,this.left=null!=n?n:t_.EMPTY,this.right=null!=i?i:t_.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,n,i){return new t_(null!=e?e:this.key,null!=t?t:this.value,null!=r?r:this.color,null!=n?n:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let n=this,i=r(e,n.key);return(n=i<0?n.copy(null,null,null,n.left.insert(e,t,r),null):0===i?n.copy(null,t,null,null,null):n.copy(null,null,null,null,n.right.insert(e,t,r))).fixUp()}removeMin(){if(this.left.isEmpty())return t_.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let r,n=this;if(0>t(e,n.key))n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed()&&(n=n.rotateRight()),n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight()),0===t(e,n.key)){if(n.right.isEmpty())return t_.EMPTY;r=n.right.min(),n=n.copy(r.key,r.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,t_.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,t_.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw x();let e=this.left.check();if(e!==this.right.check())throw x();return e+(this.isRed()?0:1)}}t_.EMPTY=null,t_.RED=!0,t_.BLACK=!1,t_.EMPTY=new class{constructor(){this.size=0}get key(){throw x()}get value(){throw x()}get color(){throw x()}get left(){throw x()}get right(){throw x()}copy(e,t,r,n,i){return this}insert(e,t,r){return new t_(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tx{constructor(e){this.comparator=e,this.data=new tE(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let n=r.getNext();if(this.comparator(n.key,e[1])>=0)return;t(n.key)}}forEachWhile(e,t){let r;for(r=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tS(this.data.getIterator())}getIteratorFrom(e){return new tS(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tx)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,n=r.getNext().key;if(0!==this.comparator(e,n))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tx(this.comparator);return t.data=e,t}}class tS{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tN(e){return e.hasNext()?e.getNext():void 0}class tk{constructor(e){this.fields=e,e.sort(j.comparator)}static empty(){return new tk([])}unionWith(e){let t=new tx(j.comparator);for(let e of this.fields)t=t.add(e);for(let r of e)t=t.add(r);return new tk(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return U(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tD extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tC{constructor(e){this.binaryString=e}static fromBase64String(e){return new tC(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tD("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tC(function(e){let t="";for(let r=0;r<e.length;++r)t+=String.fromCharCode(e[r]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(e){let t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return P(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tC.EMPTY_BYTE_STRING=new tC("");let tA=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tV(e){if(e||x(),"string"==typeof e){let t=0,r=tA.exec(e);if(r||x(),r[1]){let e=r[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tR(e.seconds),nanos:tR(e.nanos)}}function tR(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function tO(e){return"string"==typeof e?tC.fromBase64String(e):tC.fromUint8Array(e)}let tM="server_timestamp",tL="__type__",tF="__previous_value__",tP="__local_write_time__";function tU(e){var t,r;return(null===(r=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[tL])||void 0===r?void 0:r.stringValue)===tM}function tq(e){let t=e.mapValue.fields[tF];return tU(t)?tq(t):t}function tB(e){let t=tV(e.mapValue.fields[tP].timestampValue);return new q(t.seconds,t.nanos)}class tK{constructor(e,t,r,n,i,s,a,o,l){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=n,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l}}let tz="(default)";class t${constructor(e,t){this.projectId=e,this.database=t||tz}static empty(){return new t$("","")}get isDefaultDatabase(){return this.database===tz}isEqual(e){return e instanceof t$&&e.projectId===this.projectId&&e.database===this.database}}let tG="__type__",tj="__max__",tQ={mapValue:{fields:{__type__:{stringValue:tj}}}},tH="__vector__",tW="value",tY={nullValue:"NULL_VALUE"};function tZ(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tU(e)?4:rr(e)?0x1fffffffffffff:re(e)?10:11:x()}function tJ(e,t){if(e===t)return!0;let r=tZ(e);if(r!==tZ(t))return!1;switch(r){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tB(e).isEqual(tB(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=tV(e.timestampValue),n=tV(t.timestampValue);return r.seconds===n.seconds&&r.nanos===n.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return tO(e.bytesValue).isEqual(tO(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tR(e.geoPointValue.latitude)===tR(t.geoPointValue.latitude)&&tR(e.geoPointValue.longitude)===tR(t.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return tR(e.integerValue)===tR(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let r=tR(e.doubleValue),n=tR(t.doubleValue);return r===n?eb(r)===eb(n):isNaN(r)&&isNaN(n)}return!1}(e,t);case 9:return U(e.arrayValue.values||[],t.arrayValue.values||[],tJ);case 10:case 11:return function(e,t){let r=e.mapValue.fields||{},n=t.mapValue.fields||{};if(tv(r)!==tv(n))return!1;for(let e in r)if(r.hasOwnProperty(e)&&(void 0===n[e]||!tJ(r[e],n[e])))return!1;return!0}(e,t);default:return x()}}function tX(e,t){return void 0!==(e.values||[]).find(e=>tJ(e,t))}function t0(e,t){if(e===t)return 0;let r=tZ(e),n=tZ(t);if(r!==n)return P(r,n);switch(r){case 0:case 0x1fffffffffffff:return 0;case 1:return P(e.booleanValue,t.booleanValue);case 2:return function(e,t){let r=tR(e.integerValue||e.doubleValue),n=tR(t.integerValue||t.doubleValue);return r<n?-1:r>n?1:r===n?0:isNaN(r)?isNaN(n)?0:-1:1}(e,t);case 3:return t1(e.timestampValue,t.timestampValue);case 4:return t1(tB(e),tB(t));case 5:return P(e.stringValue,t.stringValue);case 6:return function(e,t){let r=tO(e),n=tO(t);return r.compareTo(n)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let r=e.split("/"),n=t.split("/");for(let e=0;e<r.length&&e<n.length;e++){let t=P(r[e],n[e]);if(0!==t)return t}return P(r.length,n.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let r=P(tR(e.latitude),tR(t.latitude));return 0!==r?r:P(tR(e.longitude),tR(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return t2(e.arrayValue,t.arrayValue);case 10:return function(e,t){var r,n,i,s;let a=e.fields||{},o=t.fields||{},l=null===(r=a[tW])||void 0===r?void 0:r.arrayValue,u=null===(n=o[tW])||void 0===n?void 0:n.arrayValue,h=P((null===(i=null==l?void 0:l.values)||void 0===i?void 0:i.length)||0,(null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0);return 0!==h?h:t2(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===tQ.mapValue&&t===tQ.mapValue)return 0;if(e===tQ.mapValue)return 1;if(t===tQ.mapValue)return -1;let r=e.fields||{},n=Object.keys(r),i=t.fields||{},s=Object.keys(i);n.sort(),s.sort();for(let e=0;e<n.length&&e<s.length;++e){let t=P(n[e],s[e]);if(0!==t)return t;let a=t0(r[n[e]],i[s[e]]);if(0!==a)return a}return P(n.length,s.length)}(e.mapValue,t.mapValue);default:throw x()}}function t1(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return P(e,t);let r=tV(e),n=tV(t),i=P(r.seconds,n.seconds);return 0!==i?i:P(r.nanos,n.nanos)}function t2(e,t){let r=e.values||[],n=t.values||[];for(let e=0;e<r.length&&e<n.length;++e){let t=t0(r[e],n[e]);if(t)return t}return P(r.length,n.length)}function t5(e){var t,r;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tV(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?tO(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,Q.fromName(t).toString()):"geoPointValue"in e?(r=e.geoPointValue,`geo(${r.latitude},${r.longitude})`):"arrayValue"in e?function(e){let t="[",r=!0;for(let n of e.values||[])r?r=!1:t+=",",t+=t5(n);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),r="{",n=!0;for(let i of t)n?n=!1:r+=",",r+=`${i}:${t5(e.fields[i])}`;return r+"}"}(e.mapValue):x()}function t8(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function t4(e){return!!e&&"integerValue"in e}function t3(e){return!!e&&"arrayValue"in e}function t6(e){return!!e&&"nullValue"in e}function t9(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function t7(e){return!!e&&"mapValue"in e}function re(e){var t,r;return(null===(r=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[tG])||void 0===r?void 0:r.stringValue)===tH}function rt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return tI(e.mapValue.fields,(e,r)=>t.mapValue.fields[e]=rt(r)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let r=0;r<(e.arrayValue.values||[]).length;++r)t.arrayValue.values[r]=rt(e.arrayValue.values[r]);return t}return Object.assign({},e)}function rr(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===tj}let rn={mapValue:{fields:{[tG]:{stringValue:tH},[tW]:{arrayValue:{}}}}};function ri(e,t){let r=t0(e.value,t.value);return 0!==r?r:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function rs(e,t){let r=t0(e.value,t.value);return 0!==r?r:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class ra{constructor(e){this.value=e}static empty(){return new ra({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(!t7(t=(t.mapValue.fields||{})[e.get(r)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=rt(t)}setAll(e){let t=j.emptyPath(),r={},n=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,r,n),r={},n=[],t=i.popLast()}e?r[i.lastSegment()]=rt(e):n.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,r,n)}delete(e){let t=this.field(e.popLast());t7(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return tJ(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let n=t.mapValue.fields[e.get(r)];t7(n)&&n.mapValue.fields||(n={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=n),t=n}return t.mapValue.fields}applyChanges(e,t,r){for(let n of(tI(t,(t,r)=>e[t]=r),r))delete e[n]}clone(){return new ra(rt(this.value))}}class ro{constructor(e,t,r,n,i,s,a){this.key=e,this.documentType=t,this.version=r,this.readTime=n,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new ro(e,0,B.min(),B.min(),B.min(),ra.empty(),0)}static newFoundDocument(e,t,r,n){return new ro(e,1,t,B.min(),r,n,0)}static newNoDocument(e,t){return new ro(e,2,t,B.min(),B.min(),ra.empty(),0)}static newUnknownDocument(e,t){return new ro(e,3,t,B.min(),B.min(),ra.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(B.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ra.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ra.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=B.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ro&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ro(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class rl{constructor(e,t){this.position=e,this.inclusive=t}}function ru(e,t,r){let n=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(n=s.field.isKeyField()?Q.comparator(Q.fromName(a.referenceValue),r.key):t0(a,r.data.field(s.field)),"desc"===s.dir&&(n*=-1),0!==n)break}return n}function rh(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let r=0;r<e.position.length;r++)if(!tJ(e.position[r],t.position[r]))return!1;return!0}class rc{constructor(e,t="asc"){this.field=e,this.dir=t}}class rd{}class rf extends rd{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,r):new rI(e,t,r):"array-contains"===t?new r_(e,r):"in"===t?new rx(e,r):"not-in"===t?new rS(e,r):"array-contains-any"===t?new rN(e,r):new rf(e,t,r)}static createKeyFieldInFilter(e,t,r){return"in"===t?new rT(e,r):new rE(e,r)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(t0(t,this.value)):null!==t&&tZ(this.value)===tZ(t)&&this.matchesComparison(t0(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return x()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class rm extends rd{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new rm(e,t)}matches(e){return rg(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}}function rg(e){return"and"===e.op}function rp(e){return"or"===e.op}function ry(e){return rw(e)&&rg(e)}function rw(e){for(let t of e.filters)if(t instanceof rm)return!1;return!0}function rv(e,t){let r=e.filters.concat(t);return rm.create(r,e.op)}class rI extends rf{constructor(e,t,r){super(e,t,r),this.key=Q.fromName(r.referenceValue)}matches(e){let t=Q.comparator(e.key,this.key);return this.matchesComparison(t)}}class rT extends rf{constructor(e,t){super(e,"in",t),this.keys=rb("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class rE extends rf{constructor(e,t){super(e,"not-in",t),this.keys=rb("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function rb(e,t){var r;return((null===(r=t.arrayValue)||void 0===r?void 0:r.values)||[]).map(e=>Q.fromName(e.referenceValue))}class r_ extends rf{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return t3(t)&&tX(t.arrayValue,this.value)}}class rx extends rf{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&tX(this.value.arrayValue,t)}}class rS extends rf{constructor(e,t){super(e,"not-in",t)}matches(e){if(tX(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&!tX(this.value.arrayValue,t)}}class rN extends rf{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!t3(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>tX(this.value.arrayValue,e))}}class rk{constructor(e,t=null,r=[],n=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=n,this.limit=i,this.startAt=s,this.endAt=a,this.le=null}}function rD(e,t=null,r=[],n=[],i=null,s=null,a=null){return new rk(e,t,r,n,i,s,a)}function rC(e){if(null===e.le){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof rf)return t.field.canonicalString()+t.op.toString()+t5(t.value);if(ry(t))return t.filters.map(t=>e(t)).join(",");{let r=t.filters.map(t=>e(t)).join(",");return`${t.op}(${r})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),null==e.limit||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>t5(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>t5(e)).join(",")),e.le=t}return e.le}function rA(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var r,n;if(r=e.orderBy[i],n=t.orderBy[i],!(r.dir===n.dir&&r.field.isEqual(n.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let r=0;r<e.filters.length;r++)if(!function e(t,r){return t instanceof rf?r instanceof rf&&t.op===r.op&&t.field.isEqual(r.field)&&tJ(t.value,r.value):t instanceof rm?r instanceof rm&&t.op===r.op&&t.filters.length===r.filters.length&&t.filters.reduce((t,n,i)=>t&&e(n,r.filters[i]),!0):void x()}(e.filters[r],t.filters[r]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!rh(e.startAt,t.startAt)&&rh(e.endAt,t.endAt)}function rV(e){return Q.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function rR(e,t){return e.filters.filter(e=>e instanceof rf&&e.field.isEqual(t))}function rO(e,t,r){let n=tY,i=!0;for(let r of rR(e,t)){let e=tY,t=!0;switch(r.op){case"<":case"<=":var s;e="nullValue"in(s=r.value)?tY:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?t8(t$.empty(),Q.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?re(s)?rn:{mapValue:{}}:x();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=tY}0>ri({value:n,inclusive:i},{value:e,inclusive:t})&&(n=e,i=t)}if(null!==r){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=r.position[s];0>ri({value:n,inclusive:i},{value:e,inclusive:r.inclusive})&&(n=e,i=r.inclusive);break}}return{value:n,inclusive:i}}function rM(e,t,r){let n=tQ,i=!0;for(let r of rR(e,t)){let e=tQ,t=!0;switch(r.op){case">=":case">":var s;e="nullValue"in(s=r.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?t8(t$.empty(),Q.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?rn:"mapValue"in s?re(s)?{mapValue:{}}:tQ:x(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=tQ}rs({value:n,inclusive:i},{value:e,inclusive:t})>0&&(n=e,i=t)}if(null!==r){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=r.position[s];rs({value:n,inclusive:i},{value:e,inclusive:r.inclusive})>0&&(n=e,i=r.inclusive);break}}return{value:n,inclusive:i}}class rL{constructor(e,t=null,r=[],n=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=n,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.he=null,this.Pe=null,this.Te=null,this.startAt,this.endAt}}function rF(e){return new rL(e)}function rP(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function rU(e){return null!==e.collectionGroup}function rq(e){if(null===e.he){let t;e.he=[];let r=new Set;for(let t of e.explicitOrderBy)e.he.push(t),r.add(t.field.canonicalString());let n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tx(j.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{r.has(t.canonicalString())||t.isKeyField()||e.he.push(new rc(t,n))}),r.has(j.keyField().canonicalString())||e.he.push(new rc(j.keyField(),n))}return e.he}function rB(e){return e.Pe||(e.Pe=function(e,t){if("F"===e.limitType)return rD(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new rc(e.field,t)});let r=e.endAt?new rl(e.endAt.position,e.endAt.inclusive):null,n=e.startAt?new rl(e.startAt.position,e.startAt.inclusive):null;return rD(e.path,e.collectionGroup,t,e.filters,e.limit,r,n)}}(e,rq(e))),e.Pe}function rK(e,t){let r=e.filters.concat([t]);return new rL(e.path,e.collectionGroup,e.explicitOrderBy.slice(),r,e.limit,e.limitType,e.startAt,e.endAt)}function rz(e,t,r){return new rL(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,r,e.startAt,e.endAt)}function r$(e,t){return rA(rB(e),rB(t))&&e.limitType===t.limitType}function rG(e){return`${rC(rB(e))}|lt:${e.limitType}`}function rj(e){var t;let r;return`Query(target=${r=(t=rB(e)).path.canonicalString(),null!==t.collectionGroup&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof rf?`${t.field.canonicalString()} ${t.op} ${t5(t.value)}`:t instanceof rm?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),null==t.limit||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(e=>t5(e)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(e=>t5(e)).join(",")),`Target(${r})`}; limitType=${e.limitType})`}function rQ(e,t){return t.isFoundDocument()&&function(e,t){let r=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(r):Q.isDocumentKey(e.path)?e.path.isEqual(r):e.path.isImmediateParentOf(r)}(e,t)&&function(e,t){for(let r of rq(e))if(!r.field.isKeyField()&&null===t.data.field(r.field))return!1;return!0}(e,t)&&function(e,t){for(let r of e.filters)if(!r.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,r){let n=ru(e,t,r);return e.inclusive?n<=0:n<0}(e.startAt,rq(e),t))&&(!e.endAt||!!function(e,t,r){let n=ru(e,t,r);return e.inclusive?n>=0:n>0}(e.endAt,rq(e),t))}function rH(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function rW(e){return(t,r)=>{let n=!1;for(let i of rq(e)){let e=function(e,t,r){let n=e.field.isKeyField()?Q.comparator(t.key,r.key):function(e,t,r){let n=t.data.field(e),i=r.data.field(e);return null!==n&&null!==i?t0(n,i):x()}(e.field,t,r);switch(e.dir){case"asc":return n;case"desc":return -1*n;default:return x()}}(i,t,r);if(0!==e)return e;n=n||i.field.isKeyField()}return 0}}class rY{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r){for(let[t,n]of r)if(this.equalsFn(t,e))return n}}has(e){return void 0!==this.get(e)}set(e,t){let r=this.mapKeyFn(e),n=this.inner[r];if(void 0===n)return this.inner[r]=[[e,t]],void this.innerSize++;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return void(n[r]=[e,t]);n.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(void 0===r)return!1;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return 1===r.length?delete this.inner[t]:r.splice(n,1),this.innerSize--,!0;return!1}forEach(e){tI(this.inner,(t,r)=>{for(let[t,n]of r)e(t,n)})}isEmpty(){return tT(this.inner)}size(){return this.innerSize}}let rZ=new tE(Q.comparator),rJ=new tE(Q.comparator);function rX(...e){let t=rJ;for(let r of e)t=t.insert(r.key,r);return t}function r0(e){let t=rJ;return e.forEach((e,r)=>t=t.insert(e,r.overlayedDocument)),t}function r1(){return new rY(e=>e.toString(),(e,t)=>e.isEqual(t))}let r2=new tE(Q.comparator),r5=new tx(Q.comparator);function r8(...e){let t=r5;for(let r of e)t=t.add(r);return t}let r4=new tx(P);function r3(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eb(t)?"-0":t}}function r6(e){return{integerValue:""+e}}function r9(e,t){return e_(t)?r6(t):r3(e,t)}class r7{constructor(){this._=void 0}}function ne(e,t){return e instanceof na?t4(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class nt extends r7{}class nr extends r7{constructor(e){super(),this.elements=e}}function nn(e,t){let r=nl(t);for(let t of e.elements)r.some(e=>tJ(e,t))||r.push(t);return{arrayValue:{values:r}}}class ni extends r7{constructor(e){super(),this.elements=e}}function ns(e,t){let r=nl(t);for(let t of e.elements)r=r.filter(e=>!tJ(e,t));return{arrayValue:{values:r}}}class na extends r7{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function no(e){return tR(e.integerValue||e.doubleValue)}function nl(e){return t3(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class nu{constructor(e,t){this.field=e,this.transform=t}}class nh{constructor(e,t){this.version=e,this.transformResults=t}}class nc{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new nc}static exists(e){return new nc(void 0,e)}static updateTime(e){return new nc(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function nd(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class nf{}function nm(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new nE(e.key,nc.none()):new ny(e.key,e.data,nc.none());{let r=e.data,n=ra.empty(),i=new tx(j.comparator);for(let e of t.fields)if(!i.has(e)){let t=r.field(e);null===t&&e.length>1&&(e=e.popLast(),t=r.field(e)),null===t?n.delete(e):n.set(e,t),i=i.add(e)}return new nw(e.key,n,new tk(i.toArray()),nc.none())}}function ng(e,t,r,n){return e instanceof ny?function(e,t,r,n){if(!nd(e.precondition,t))return r;let i=e.value.clone(),s=nT(e.fieldTransforms,n,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,r,n):e instanceof nw?function(e,t,r,n){if(!nd(e.precondition,t))return r;let i=nT(e.fieldTransforms,n,t),s=t.data;return(s.setAll(nv(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===r)?null:r.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,r,n):nd(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):r}function np(e,t){var r,n;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(r=e.fieldTransforms,n=t.fieldTransforms,!!(void 0===r&&void 0===n||!(!r||!n)&&U(r,n,(e,t)=>{var r,n;return e.field.isEqual(t.field)&&(r=e.transform,n=t.transform,r instanceof nr&&n instanceof nr||r instanceof ni&&n instanceof ni?U(r.elements,n.elements,tJ):r instanceof na&&n instanceof na?tJ(r.Ie,n.Ie):r instanceof nt&&n instanceof nt)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class ny extends nf{constructor(e,t,r,n=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=n,this.type=0}getFieldMask(){return null}}class nw extends nf{constructor(e,t,r,n,i=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=n,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function nv(e){let t=new Map;return e.fieldMask.fields.forEach(r=>{if(!r.isEmpty()){let n=e.data.field(r);t.set(r,n)}}),t}function nI(e,t,r){var n;let i=new Map;e.length===r.length||x();for(let s=0;s<r.length;s++){let a=e[s],o=a.transform,l=t.data.field(a.field);i.set(a.field,(n=r[s],o instanceof nr?nn(o,l):o instanceof ni?ns(o,l):n))}return i}function nT(e,t,r){let n=new Map;for(let i of e){let e=i.transform,s=r.data.field(i.field);n.set(i.field,e instanceof nt?function(e,t){let r={fields:{[tL]:{stringValue:tM},[tP]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tU(t)&&(t=tq(t)),t&&(r.fields[tF]=t),{mapValue:r}}(t,s):e instanceof nr?nn(e,s):e instanceof ni?ns(e,s):function(e,t){let r=ne(e,t),n=no(r)+no(e.Ie);return t4(r)&&t4(e.Ie)?r6(n):r3(e.serializer,n)}(e,s))}return n}class nE extends nf{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class nb extends nf{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class n_{constructor(e,t,r,n){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=n}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let i=this.mutations[t];if(i.key.isEqual(e.key)){var n;n=r[t],i instanceof ny?function(e,t,r){let n=e.value.clone(),i=nI(e.fieldTransforms,t,r.transformResults);n.setAll(i),t.convertToFoundDocument(r.version,n).setHasCommittedMutations()}(i,e,n):i instanceof nw?function(e,t,r){if(!nd(e.precondition,t))return void t.convertToUnknownDocument(r.version);let n=nI(e.fieldTransforms,t,r.transformResults),i=t.data;i.setAll(nv(e)),i.setAll(n),t.convertToFoundDocument(r.version,i).setHasCommittedMutations()}(i,e,n):function(e,t,r){t.convertToNoDocument(r.version).setHasCommittedMutations()}(0,e,n)}}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=ng(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=ng(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=r1();return this.mutations.forEach(n=>{let i=e.get(n.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=nm(s,a=t.has(n.key)?null:a);null!==o&&r.set(n.key,o),s.isValidDocument()||s.convertToNoDocument(B.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),r8())}isEqual(e){return this.batchId===e.batchId&&U(this.mutations,e.mutations,(e,t)=>np(e,t))&&U(this.baseMutations,e.baseMutations,(e,t)=>np(e,t))}}class nx{constructor(e,t,r,n){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=n}static from(e,t,r){e.mutations.length===r.length||x();let n=r2,i=e.mutations;for(let e=0;e<i.length;e++)n=n.insert(i[e].key,r[e].version);return new nx(e,t,r,n)}}class nS{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class nN{constructor(e,t){this.count=e,this.unchangedNames=t}}function nk(e){if(void 0===e)return E("GRPC error has no .code"),S.UNKNOWN;switch(e){case n.OK:return S.OK;case n.CANCELLED:return S.CANCELLED;case n.UNKNOWN:return S.UNKNOWN;case n.DEADLINE_EXCEEDED:return S.DEADLINE_EXCEEDED;case n.RESOURCE_EXHAUSTED:return S.RESOURCE_EXHAUSTED;case n.INTERNAL:return S.INTERNAL;case n.UNAVAILABLE:return S.UNAVAILABLE;case n.UNAUTHENTICATED:return S.UNAUTHENTICATED;case n.INVALID_ARGUMENT:return S.INVALID_ARGUMENT;case n.NOT_FOUND:return S.NOT_FOUND;case n.ALREADY_EXISTS:return S.ALREADY_EXISTS;case n.PERMISSION_DENIED:return S.PERMISSION_DENIED;case n.FAILED_PRECONDITION:return S.FAILED_PRECONDITION;case n.ABORTED:return S.ABORTED;case n.OUT_OF_RANGE:return S.OUT_OF_RANGE;case n.UNIMPLEMENTED:return S.UNIMPLEMENTED;case n.DATA_LOSS:return S.DATA_LOSS;default:return x()}}(i=n||(n={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let nD=new c.jz([0xffffffff,0xffffffff],0);function nC(e){let t=(new TextEncoder).encode(e),r=new c.VV;return r.update(t),new Uint8Array(r.digest())}function nA(e){let t=new DataView(e.buffer),r=t.getUint32(0,!0),n=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([r,n],0),new c.jz([i,s],0)]}class nV{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new nR(`Invalid padding: ${t}`);if(r<0||e.length>0&&0===this.hashCount)throw new nR(`Invalid hash count: ${r}`);if(0===e.length&&0!==t)throw new nR(`Invalid padding when bitmap length is 0: ${t}`);this.Ee=8*e.length-t,this.de=c.jz.fromNumber(this.Ee)}Ae(e,t,r){let n=e.add(t.multiply(c.jz.fromNumber(r)));return 1===n.compare(nD)&&(n=new c.jz([n.getBits(0),n.getBits(1)],0)),n.modulo(this.de).toNumber()}Re(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ee)return!1;let[t,r]=nA(nC(e));for(let e=0;e<this.hashCount;e++){let n=this.Ae(t,r,e);if(!this.Re(n))return!1}return!0}static create(e,t,r){let n=new nV(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return r.forEach(e=>n.insert(e)),n}insert(e){if(0===this.Ee)return;let[t,r]=nA(nC(e));for(let e=0;e<this.hashCount;e++){let n=this.Ae(t,r,e);this.Ve(n)}}Ve(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class nR extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class nO{constructor(e,t,r,n,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=n,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let n=new Map;return n.set(e,nM.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new nO(B.min(),n,new tE(P),rZ,r8())}}class nM{constructor(e,t,r,n,i){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=n,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new nM(r,t,r8(),r8(),r8())}}class nL{constructor(e,t,r,n){this.me=e,this.removedTargetIds=t,this.key=r,this.fe=n}}class nF{constructor(e,t){this.targetId=e,this.ge=t}}class nP{constructor(e,t,r=tC.EMPTY_BYTE_STRING,n=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=n}}class nU{constructor(){this.pe=0,this.ye=nK(),this.we=tC.EMPTY_BYTE_STRING,this.be=!1,this.Se=!0}get current(){return this.be}get resumeToken(){return this.we}get De(){return 0!==this.pe}get ve(){return this.Se}Ce(e){e.approximateByteSize()>0&&(this.Se=!0,this.we=e)}Fe(){let e=r8(),t=r8(),r=r8();return this.ye.forEach((n,i)=>{switch(i){case 0:e=e.add(n);break;case 2:t=t.add(n);break;case 1:r=r.add(n);break;default:x()}}),new nM(this.we,this.be,e,t,r)}Me(){this.Se=!1,this.ye=nK()}xe(e,t){this.Se=!0,this.ye=this.ye.insert(e,t)}Oe(e){this.Se=!0,this.ye=this.ye.remove(e)}Ne(){this.pe+=1}Be(){this.pe-=1,this.pe>=0||x()}Le(){this.Se=!0,this.be=!0}}class nq{constructor(e){this.ke=e,this.qe=new Map,this.Qe=rZ,this.$e=nB(),this.Ke=nB(),this.Ue=new tE(P)}We(e){for(let t of e.me)e.fe&&e.fe.isFoundDocument()?this.Ge(t,e.fe):this.ze(t,e.key,e.fe);for(let t of e.removedTargetIds)this.ze(t,e.key,e.fe)}je(e){this.forEachTarget(e,t=>{let r=this.He(t);switch(e.state){case 0:this.Je(t)&&r.Ce(e.resumeToken);break;case 1:r.Be(),r.De||r.Me(),r.Ce(e.resumeToken);break;case 2:r.Be(),r.De||this.removeTarget(t);break;case 3:this.Je(t)&&(r.Le(),r.Ce(e.resumeToken));break;case 4:this.Je(t)&&(this.Ye(t),r.Ce(e.resumeToken));break;default:x()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.qe.forEach((e,r)=>{this.Je(r)&&t(r)})}Ze(e){let t=e.targetId,r=e.ge.count,n=this.Xe(t);if(n){let i=n.target;if(rV(i)){if(0===r){let e=new Q(i.path);this.ze(t,e,ro.newNoDocument(e,B.min()))}else 1===r||x()}else{let n=this.et(t);if(n!==r){let r=this.tt(e),i=r?this.nt(r,e,n):1;0!==i&&(this.Ye(t),this.Ue=this.Ue.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}tt(e){let t,r;let n=e.ge.unchangedNames;if(!n||!n.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=n;try{t=tO(i).toUint8Array()}catch(e){if(e instanceof tD)return b("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{r=new nV(t,s,a)}catch(e){return b(e instanceof nR?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===r.Ee?null:r}nt(e,t,r){return t.ge.count===r-this.st(e,t.targetId)?0:2}st(e,t){let r=this.ke.getRemoteKeysForTarget(t),n=0;return r.forEach(r=>{let i=this.ke.it(),s=`projects/${i.projectId}/databases/${i.database}/documents/${r.path.canonicalString()}`;e.mightContain(s)||(this.ze(t,r,null),n++)}),n}ot(e){let t=new Map;this.qe.forEach((r,n)=>{let i=this.Xe(n);if(i){if(r.current&&rV(i.target)){let t=new Q(i.target.path);this._t(t).has(n)||this.ut(n,t)||this.ze(n,t,ro.newNoDocument(t,e))}r.ve&&(t.set(n,r.Fe()),r.Me())}});let r=r8();this.Ke.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{let t=this.Xe(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(n=!1,!1)}),n&&(r=r.add(e))}),this.Qe.forEach((t,r)=>r.setReadTime(e));let n=new nO(e,t,this.Ue,this.Qe,r);return this.Qe=rZ,this.$e=nB(),this.Ke=nB(),this.Ue=new tE(P),n}Ge(e,t){if(!this.Je(e))return;let r=this.ut(e,t.key)?2:0;this.He(e).xe(t.key,r),this.Qe=this.Qe.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)),this.Ke=this.Ke.insert(t.key,this.ct(t.key).add(e))}ze(e,t,r){if(!this.Je(e))return;let n=this.He(e);this.ut(e,t)?n.xe(t,1):n.Oe(t),this.Ke=this.Ke.insert(t,this.ct(t).delete(e)),this.Ke=this.Ke.insert(t,this.ct(t).add(e)),r&&(this.Qe=this.Qe.insert(t,r))}removeTarget(e){this.qe.delete(e)}et(e){let t=this.He(e).Fe();return this.ke.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ne(e){this.He(e).Ne()}He(e){let t=this.qe.get(e);return t||(t=new nU,this.qe.set(e,t)),t}ct(e){let t=this.Ke.get(e);return t||(t=new tx(P),this.Ke=this.Ke.insert(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new tx(P),this.$e=this.$e.insert(e,t)),t}Je(e){let t=null!==this.Xe(e);return t||T("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){let t=this.qe.get(e);return t&&t.De?null:this.ke.lt(e)}Ye(e){this.qe.set(e,new nU),this.ke.getRemoteKeysForTarget(e).forEach(t=>{this.ze(e,t,null)})}ut(e,t){return this.ke.getRemoteKeysForTarget(e).has(t)}}function nB(){return new tE(Q.comparator)}function nK(){return new tE(Q.comparator)}let nz={asc:"ASCENDING",desc:"DESCENDING"},n$={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},nG={and:"AND",or:"OR"};class nj{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function nQ(e,t){return e.useProto3Json||null==t?t:{value:t}}function nH(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function nW(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function nY(e){return e||x(),B.fromTimestamp(function(e){let t=tV(e);return new q(t.seconds,t.nanos)}(e))}function nZ(e,t){return nJ(e,t).canonicalString()}function nJ(e,t){let r=new $(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?r:r.child(t)}function nX(e){let t=$.fromString(e);return ia(t)||x(),t}function n0(e,t){return nZ(e.databaseId,t.path)}function n1(e,t){let r=nX(t);if(r.get(1)!==e.databaseId.projectId)throw new N(S.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+r.get(1)+" vs "+e.databaseId.projectId);if(r.get(3)!==e.databaseId.database)throw new N(S.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+r.get(3)+" vs "+e.databaseId.database);return new Q(n4(r))}function n2(e,t){return nZ(e.databaseId,t)}function n5(e){let t=nX(e);return 4===t.length?$.emptyPath():n4(t)}function n8(e){return new $(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function n4(e){return e.length>4&&"documents"===e.get(4)||x(),e.popFirst(5)}function n3(e,t,r){return{name:n0(e,t),fields:r.value.mapValue.fields}}function n6(e,t,r){let n=n1(e,t.name),i=nY(t.updateTime),s=t.createTime?nY(t.createTime):B.min(),a=new ra({mapValue:{fields:t.fields}}),o=ro.newFoundDocument(n,i,s,a);return r&&o.setHasCommittedMutations(),r?o.setHasCommittedMutations():o}function n9(e,t){var r;let n;if(t instanceof ny)n={update:n3(e,t.key,t.value)};else if(t instanceof nE)n={delete:n0(e,t.key)};else if(t instanceof nw)n={update:n3(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof nb))return x();n={verify:n0(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let r=t.transform;if(r instanceof nt)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(r instanceof nr)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:r.elements}};if(r instanceof ni)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:r.elements}};if(r instanceof na)return{fieldPath:t.field.canonicalString(),increment:r.Ie};throw x()})(0,e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:nH(e,r.updateTime.toTimestamp())}:void 0!==r.exists?{exists:r.exists}:x()),n}function n7(e,t){var r;let n=t.currentDocument?void 0!==(r=t.currentDocument).updateTime?nc.updateTime(nY(r.updateTime)):void 0!==r.exists?nc.exists(r.exists):nc.none():nc.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let r;return r=null,"setToServerValue"in t?("REQUEST_TIME"===t.setToServerValue||x(),r=new nt):"appendMissingElements"in t?r=new nr(t.appendMissingElements.values||[]):"removeAllFromArray"in t?r=new ni(t.removeAllFromArray.values||[]):"increment"in t?r=new na(e,t.increment):x(),new nu(j.fromServerFormat(t.fieldPath),r)}):[];if(t.update){t.update.name;let r=n1(e,t.update.name),s=new ra({mapValue:{fields:t.update.fields}});return t.updateMask?new nw(r,s,new tk((t.updateMask.fieldPaths||[]).map(e=>j.fromServerFormat(e))),n,i):new ny(r,s,n,i)}return t.delete?new nE(n1(e,t.delete),n):t.verify?new nb(n1(e,t.verify),n):x()}function ie(e,t){return{documents:[n2(e,t.path)]}}function it(e,t){var r,n;let i;let s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=n2(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof rf?function(e){if("=="===e.op){if(t9(e.value))return{unaryFilter:{field:ii(e.field),op:"IS_NAN"}};if(t6(e.value))return{unaryFilter:{field:ii(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(t9(e.value))return{unaryFilter:{field:ii(e.field),op:"IS_NOT_NAN"}};if(t6(e.value))return{unaryFilter:{field:ii(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ii(e.field),op:n$[e.op],value:e.value}}}(t):t instanceof rm?function(t){let r=t.getFilters().map(t=>e(t));return 1===r.length?r[0]:{compositeFilter:{op:nG[t.op],filters:r}}}(t):x()}(rm.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:ii(e.field),direction:nz[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=nQ(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(r=t.startAt).inclusive,values:r.position}),t.endAt&&(s.structuredQuery.endAt={before:!(n=t.endAt).inclusive,values:n.position}),{ht:s,parent:i}}function ir(e){var t;let r,n=n5(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){1===s||x();let e=i.from[0];e.allDescendants?a=e.collectionId:n=n.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=is(e.unaryFilter.field);return rf.create(t,"==",{doubleValue:NaN});case"IS_NULL":let r=is(e.unaryFilter.field);return rf.create(r,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let n=is(e.unaryFilter.field);return rf.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=is(e.unaryFilter.field);return rf.create(i,"!=",{nullValue:"NULL_VALUE"});default:return x()}}(t):void 0!==t.fieldFilter?rf.create(is(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return x()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?rm.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return x()}}(t.compositeFilter.op)):x()}(e);return t instanceof rm&&ry(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new rc(is(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=null==(r="object"==typeof(t=i.limit)?t.value:t)?null:r);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new rl(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new rl(e.values||[],t)}(i.endAt)),new rL(n,a,l,o,u,"F",h,c)}function ii(e){return{fieldPath:e.canonicalString()}}function is(e){return j.fromServerFormat(e.fieldPath)}function ia(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class io{constructor(e,t,r,n,i=B.min(),s=B.min(),a=tC.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=n,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new io(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new io(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new io(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new io(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class il{constructor(e){this.Tt=e}}function iu(e,t){let r=t.key,n={prefixPath:r.getCollectionPath().popLast().toArray(),collectionGroup:r.collectionGroup,documentId:r.path.lastSegment(),readTime:ih(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;n.document={name:n0(i=e.Tt,t.key),fields:t.data.value.mapValue.fields,updateTime:nH(i,t.version.toTimestamp()),createTime:nH(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())n.noDocument={path:r.path.toArray(),readTime:ic(t.version)};else{if(!t.isUnknownDocument())return x();n.unknownDocument={path:r.path.toArray(),version:ic(t.version)}}return n}function ih(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function ic(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function id(e){let t=new q(e.seconds,e.nanoseconds);return B.fromTimestamp(t)}function im(e,t){let r=(t.baseMutations||[]).map(t=>n7(e.Tt,t));for(let e=0;e<t.mutations.length-1;++e){let r=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){let n=t.mutations[e+1];r.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}let n=t.mutations.map(t=>n7(e.Tt,t)),i=q.fromMillis(t.localWriteTimeMs);return new n_(t.batchId,i,r,n)}function ig(e){var t;let r=id(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?id(e.lastLimboFreeSnapshotVersion):B.min();return new io(void 0!==e.query.documents?(1===(t=e.query).documents.length||x(),rB(rF(n5(t.documents[0])))):rB(ir(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,r,n,tC.fromBase64String(e.resumeToken))}function ip(e,t){let r;let n=ic(t.snapshotVersion),i=ic(t.lastLimboFreeSnapshotVersion);r=rV(t.target)?ie(e.Tt,t.target):it(e.Tt,t.target).ht;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:rC(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:r}}function iy(e){let t=ir({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?rz(t,t.limit,"L"):t}function iw(e,t){return new nS(t.largestBatchId,n7(e.Tt,t.overlayMutation))}function iv(e,t){let r=t.path.lastSegment();return[e,ex(t.path.popLast()),r]}function iI(e,t,r,n){return{indexId:e,uid:t,sequenceNumber:r,readTime:ic(n.readTime),documentKey:ex(n.documentKey.path),largestBatchId:n.largestBatchId}}class iT{getBundleMetadata(e,t){return tw(e,e5).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:id(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tw(e,e5).put({bundleId:t.id,createTime:ic(nY(t.createTime)),version:t.version})}getNamedQuery(e,t){return tw(e,e8).get(t).next(e=>{if(e)return{name:e.name,query:iy(e.bundledQuery),readTime:id(e.readTime)}})}saveNamedQuery(e,t){return tw(e,e8).put({name:t.name,readTime:ic(nY(t.readTime)),bundledQuery:t.bundledQuery})}}class iE{constructor(e,t){this.serializer=e,this.userId=t}static It(e,t){return new iE(e,t.uid||"")}getOverlay(e,t){return tw(e,ts).get(iv(this.userId,t)).next(e=>e?iw(this.serializer,e):null)}getOverlays(e,t){let r=r1();return ea.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&r.set(t,e)})).next(()=>r)}saveOverlays(e,t,r){let n=[];return r.forEach((r,i)=>{let s=new nS(t,i);n.push(this.Et(e,s))}),ea.waitFor(n)}removeOverlaysForBatchId(e,t,r){let n=new Set;t.forEach(e=>n.add(ex(e.getCollectionPath())));let i=[];return n.forEach(t=>{let n=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,r+1],!1,!0);i.push(tw(e,ts).J(to,n))}),ea.waitFor(i)}getOverlaysForCollection(e,t,r){let n=r1(),i=ex(t),s=IDBKeyRange.bound([this.userId,i,r],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tw(e,ts).G(to,s).next(e=>{for(let t of e){let e=iw(this.serializer,t);n.set(e.getKey(),e)}return n})}getOverlaysForCollectionGroup(e,t,r,n){let i;let s=r1(),a=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tw(e,ts).Z({index:tu,range:a},(e,t,r)=>{let a=iw(this.serializer,t);s.size()<n||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):r.done()}).next(()=>s)}Et(e,t){return tw(e,ts).put(function(e,t,r){let[n,i,s]=iv(t,r.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:r.mutation.key.getCollectionGroup(),largestBatchId:r.largestBatchId,overlayMutation:n9(e.Tt,r.mutation)}}(this.serializer,this.userId,t))}}class ib{dt(e){return tw(e,tc)}getSessionToken(e){return this.dt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?tC.fromUint8Array(t):tC.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class i_{constructor(){}At(e,t){this.Rt(e,t),t.Vt()}Rt(e,t){if("nullValue"in e)this.ft(t,5);else if("booleanValue"in e)this.ft(t,10),t.gt(e.booleanValue?1:0);else if("integerValue"in e)this.ft(t,15),t.gt(tR(e.integerValue));else if("doubleValue"in e){let r=tR(e.doubleValue);isNaN(r)?this.ft(t,13):(this.ft(t,15),eb(r)?t.gt(0):t.gt(r))}else if("timestampValue"in e){let r=e.timestampValue;this.ft(t,20),"string"==typeof r&&(r=tV(r)),t.yt(`${r.seconds||""}`),t.gt(r.nanos||0)}else if("stringValue"in e)this.wt(e.stringValue,t),this.bt(t);else if("bytesValue"in e)this.ft(t,30),t.St(tO(e.bytesValue)),this.bt(t);else if("referenceValue"in e)this.Dt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.ft(t,45),t.gt(r.latitude||0),t.gt(r.longitude||0)}else"mapValue"in e?rr(e)?this.ft(t,Number.MAX_SAFE_INTEGER):re(e)?this.vt(e.mapValue,t):(this.Ct(e.mapValue,t),this.bt(t)):"arrayValue"in e?(this.Ft(e.arrayValue,t),this.bt(t)):x()}wt(e,t){this.ft(t,25),this.Mt(e,t)}Mt(e,t){t.yt(e)}Ct(e,t){let r=e.fields||{};for(let e of(this.ft(t,55),Object.keys(r)))this.wt(e,t),this.Rt(r[e],t)}vt(e,t){var r,n;let i=e.fields||{};this.ft(t,53);let s=(null===(n=null===(r=i[tW].arrayValue)||void 0===r?void 0:r.values)||void 0===n?void 0:n.length)||0;this.ft(t,15),t.gt(tR(s)),this.wt(tW,t),this.Rt(i[tW],t)}Ft(e,t){let r=e.values||[];for(let e of(this.ft(t,50),r))this.Rt(e,t)}Dt(e,t){this.ft(t,37),Q.fromName(e).path.forEach(e=>{this.ft(t,60),this.Mt(e,t)})}ft(e,t){e.gt(t)}bt(e){e.gt(2)}}function ix(e){return Math.ceil((64-function(e){let t=0;for(let r=0;r<8;++r){let n=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e))/8)}i_.xt=new i_;class iS{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ot(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Nt(r.value),r=t.next();this.Bt()}Lt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.kt(r.value),r=t.next();this.qt()}Qt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Nt(e);else if(e<2048)this.Nt(960|e>>>6),this.Nt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Nt(480|e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e);else{let e=t.codePointAt(0);this.Nt(240|e>>>18),this.Nt(128|63&e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e)}}this.Bt()}$t(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.kt(e);else if(e<2048)this.kt(960|e>>>6),this.kt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.kt(480|e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e);else{let e=t.codePointAt(0);this.kt(240|e>>>18),this.kt(128|63&e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e)}}this.qt()}Kt(e){let t=this.Ut(e),r=ix(t);this.Wt(1+r),this.buffer[this.position++]=255&r;for(let e=t.length-r;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Gt(e){let t=this.Ut(e),r=ix(t);this.Wt(1+r),this.buffer[this.position++]=~(255&r);for(let e=t.length-r;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}zt(){this.jt(255),this.jt(255)}Ht(){this.Jt(255),this.Jt(255)}reset(){this.position=0}seed(e){this.Wt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Yt(){return this.buffer.slice(0,this.position)}Ut(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),r=!!(128&t[0]);t[0]^=r?255:128;for(let e=1;e<t.length;++e)t[e]^=r?255:0;return t}Nt(e){let t=255&e;0===t?(this.jt(0),this.jt(255)):255===t?(this.jt(255),this.jt(0)):this.jt(t)}kt(e){let t=255&e;0===t?(this.Jt(0),this.Jt(255)):255===t?(this.Jt(255),this.Jt(0)):this.Jt(e)}Bt(){this.jt(0),this.jt(1)}qt(){this.Jt(0),this.Jt(1)}jt(e){this.Wt(1),this.buffer[this.position++]=e}Jt(e){this.Wt(1),this.buffer[this.position++]=~e}Wt(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let n=new Uint8Array(r);n.set(this.buffer),this.buffer=n}}class iN{constructor(e){this.Zt=e}St(e){this.Zt.Ot(e)}yt(e){this.Zt.Qt(e)}gt(e){this.Zt.Kt(e)}Vt(){this.Zt.zt()}}class ik{constructor(e){this.Zt=e}St(e){this.Zt.Lt(e)}yt(e){this.Zt.$t(e)}gt(e){this.Zt.Gt(e)}Vt(){this.Zt.Ht()}}class iD{constructor(){this.Zt=new iS,this.Xt=new iN(this.Zt),this.en=new ik(this.Zt)}seed(e){this.Zt.seed(e)}tn(e){return 0===e?this.Xt:this.en}Yt(){return this.Zt.Yt()}reset(){this.Zt.reset()}}class iC{constructor(e,t,r,n){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=n}nn(){let e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new iC(this.indexId,this.documentKey,this.arrayValue,r)}}function iA(e,t){let r=e.indexId-t.indexId;return 0!==r?r:0!==(r=iV(e.arrayValue,t.arrayValue))?r:0!==(r=iV(e.directionalValue,t.directionalValue))?r:Q.comparator(e.documentKey,t.documentKey)}function iV(e,t){for(let r=0;r<e.length&&r<t.length;++r){let n=e[r]-t[r];if(0!==n)return n}return e.length-t.length}class iR{constructor(e){for(let t of(this.rn=new tx((e,t)=>j.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.sn=e.orderBy,this._n=[],e.filters))t.isInequality()?this.rn=this.rn.add(t):this._n.push(t)}get an(){return this.rn.size>1}un(e){if(e.collectionGroup===this.collectionId||x(),this.an)return!1;let t=W(e);if(void 0!==t&&!this.cn(t))return!1;let r=Y(e),n=new Set,i=0,s=0;for(;i<r.length&&this.cn(r[i]);++i)n=n.add(r[i].fieldPath.canonicalString());if(i===r.length)return!0;if(this.rn.size>0){let e=this.rn.getIterator().getNext();if(!n.has(e.field.canonicalString())){let t=r[i];if(!this.ln(e,t)||!this.hn(this.sn[s++],t))return!1}++i}for(;i<r.length;++i){let e=r[i];if(s>=this.sn.length||!this.hn(this.sn[s++],e))return!1}return!0}Pn(){if(this.an)return null;let e=new tx(j.comparator),t=[];for(let r of this._n)if(!r.field.isKeyField()){if("array-contains"===r.op||"array-contains-any"===r.op)t.push(new Z(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new Z(r.field,0))}}for(let r of this.sn)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new Z(r.field,"asc"===r.dir?0:1)));return new H(H.UNKNOWN_ID,this.collectionId,t,J.empty())}cn(e){for(let t of this._n)if(this.ln(t,e))return!0;return!1}ln(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let r="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===r}hn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iO(e){return e instanceof rf}function iM(e){return e instanceof rm&&ry(e)}function iL(e){return iO(e)||iM(e)||function(e){if(e instanceof rm&&rp(e)){for(let t of e.getFilters())if(!iO(t)&&!iM(t))return!1;return!0}return!1}(e)}function iF(e,t){return e instanceof rf||e instanceof rm||x(),t instanceof rf||t instanceof rm||x(),iU(e instanceof rf?t instanceof rf?rm.create([e,t],"and"):iP(e,t):t instanceof rf?iP(t,e):function(e,t){if(e.filters.length>0&&t.filters.length>0||x(),rg(e)&&rg(t))return rv(e,t.getFilters());let r=rp(e)?e:t,n=rp(e)?t:e,i=r.filters.map(e=>iF(e,n));return rm.create(i,"or")}(e,t))}function iP(e,t){if(rg(t))return rv(t,e.getFilters());{let r=t.filters.map(t=>iF(e,t));return rm.create(r,"or")}}function iU(e){if(e instanceof rf||e instanceof rm||x(),e instanceof rf)return e;let t=e.getFilters();if(1===t.length)return iU(t[0]);if(rw(e))return e;let r=t.map(e=>iU(e)),n=[];return r.forEach(t=>{t instanceof rf?n.push(t):t instanceof rm&&(t.op===e.op?n.push(...t.filters):n.push(t))}),1===n.length?n[0]:rm.create(n,e.op)}class iq{constructor(){this.Tn=new iB}addToCollectionParentIndex(e,t){return this.Tn.add(t),ea.resolve()}getCollectionParents(e,t){return ea.resolve(this.Tn.getEntries(t))}addFieldIndex(e,t){return ea.resolve()}deleteFieldIndex(e,t){return ea.resolve()}deleteAllFieldIndexes(e){return ea.resolve()}createTargetIndexes(e,t){return ea.resolve()}getDocumentsMatchingTarget(e,t){return ea.resolve(null)}getIndexType(e,t){return ea.resolve(0)}getFieldIndexes(e,t){return ea.resolve([])}getNextCollectionGroupToUpdate(e){return ea.resolve(null)}getMinOffset(e,t){return ea.resolve(et.min())}getMinOffsetFromCollectionGroup(e,t){return ea.resolve(et.min())}updateCollectionGroup(e,t,r){return ea.resolve()}updateIndexEntries(e,t){return ea.resolve()}}class iB{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),n=this.index[t]||new tx($.comparator),i=!n.has(r);return this.index[t]=n.add(r),i}has(e){let t=e.lastSegment(),r=e.popLast(),n=this.index[t];return n&&n.has(r)}getEntries(e){return(this.index[e]||new tx($.comparator)).toArray()}}let iK="IndexedDbIndexManager",iz=new Uint8Array(0);class i${constructor(e,t){this.databaseId=t,this.In=new iB,this.En=new rY(e=>rC(e),(e,t)=>rA(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.In.has(t)){let r=t.lastSegment(),n=t.popLast();e.addOnCommittedListener(()=>{this.In.add(t)});let i={collectionId:r,parent:ex(n)};return tw(e,e0).put(i)}return ea.resolve()}getCollectionParents(e,t){let r=[],n=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tw(e,e0).G(n).next(e=>{for(let n of e){if(n.collectionId!==t)break;r.push(eS(n.parent))}return r})}addFieldIndex(e,t){let r=tw(e,e4),n={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete n.indexId;let i=r.add(n);if(t.indexState){let r=tw(e,e6);return i.next(e=>{r.put(iI(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let r=tw(e,e4),n=tw(e,e6),i=tw(e,tt);return r.delete(t.indexId).next(()=>n.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tw(e,e4),r=tw(e,tt),n=tw(e,e6);return t.J().next(()=>r.J()).next(()=>n.J())}createTargetIndexes(e,t){return ea.forEach(this.dn(t),t=>this.getIndexType(e,t).next(r=>{if(0===r||1===r){let r=new iR(t).Pn();if(null!=r)return this.addFieldIndex(e,r)}}))}getDocumentsMatchingTarget(e,t){let r=tw(e,tt),n=!0,i=new Map;return ea.forEach(this.dn(t),t=>this.An(e,t).next(e=>{n&&(n=!!e),i.set(t,e)})).next(()=>{if(n){let e=r8(),n=[];return ea.forEach(i,(i,s)=>{T(iK,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${rC(t)}`);let a=function(e,t){let r=W(t);if(void 0===r)return null;for(let t of rR(e,r.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let r=new Map;for(let n of Y(t))for(let t of rR(e,n.fieldPath))switch(t.op){case"==":case"in":r.set(n.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return r.set(n.fieldPath.canonicalString(),t.value),Array.from(r.values())}return null}(s,i),l=function(e,t){let r=[],n=!0;for(let i of Y(t)){let t=0===i.kind?rO(e,i.fieldPath,e.startAt):rM(e,i.fieldPath,e.startAt);r.push(t.value),n&&(n=t.inclusive)}return new rl(r,n)}(s,i),u=function(e,t){let r=[],n=!0;for(let i of Y(t)){let t=0===i.kind?rM(e,i.fieldPath,e.endAt):rO(e,i.fieldPath,e.endAt);r.push(t.value),n&&(n=t.inclusive)}return new rl(r,n)}(s,i),h=this.Rn(i,s,l),c=this.Rn(i,s,u),d=this.Vn(i,s,o),f=this.mn(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return ea.forEach(f,i=>r.H(i,t.limit).next(t=>{t.forEach(t=>{let r=Q.fromSegments(t.documentKey);e.has(r)||(e=e.add(r),n.push(r))})}))}).next(()=>n)}return ea.resolve(null)})}dn(e){let t=this.En.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(t instanceof rf||t instanceof rm||x(),t instanceof rf)return t;if(1===t.filters.length)return e(t.filters[0]);let r=t.filters.map(t=>e(t)),n=rm.create(r,t.op);return iL(n=iU(n))?n:(n instanceof rm||x(),rg(n)||x(),n.filters.length>1||x(),n.filters.reduce((e,t)=>iF(e,t)))}(function e(t){var r,n;if(t instanceof rf||t instanceof rm||x(),t instanceof rf){if(t instanceof rx){let e=(null===(n=null===(r=t.value.arrayValue)||void 0===r?void 0:r.values)||void 0===n?void 0:n.map(e=>rf.create(t.field,"==",e)))||[];return rm.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return rm.create(i,t.op)}(e));return iL(t)||x(),iO(t)||iM(t)?[t]:t.getFilters()})(rm.create(e.filters,"and")).map(t=>rD(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.En.set(e,t)),t}mn(e,t,r,n,i,s,a){let o=(null!=t?t.length:1)*Math.max(r.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.fn(t[h/l]):iz,c=this.gn(e,o,r[h%l],n),d=this.pn(e,o,i[h%l],s),f=a.map(t=>this.gn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}gn(e,t,r,n){let i=new iC(e,Q.empty(),t,r);return n?i:i.nn()}pn(e,t,r,n){let i=new iC(e,Q.empty(),t,r);return n?i.nn():i}An(e,t){let r=new iR(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(let n of e)r.un(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let r=2,n=this.dn(t);return ea.forEach(n,t=>this.An(e,t).next(e=>{e?0!==r&&e.fields.length<function(e){let t=new tx(j.comparator),r=!1;for(let n of e.filters)for(let e of n.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?r=!0:t=t.add(e.field));for(let r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+(r?1:0)}(t)&&(r=1):r=0})).next(()=>null!==t.limit&&n.length>1&&2===r?1:r)}yn(e,t){let r=new iD;for(let n of Y(e)){let e=t.data.field(n.fieldPath);if(null==e)return null;let i=r.tn(n.kind);i_.xt.At(e,i)}return r.Yt()}fn(e){let t=new iD;return i_.xt.At(e,t.tn(0)),t.Yt()}wn(e,t){let r=new iD;return i_.xt.At(t8(this.databaseId,t),r.tn(function(e){let t=Y(e);return 0===t.length?0:t[t.length-1].kind}(e))),r.Yt()}Vn(e,t,r){if(null===r)return[];let n=[];n.push(new iD);let i=0;for(let s of Y(e)){let e=r[i++];for(let r of n)if(this.bn(t,s.fieldPath)&&t3(e))n=this.Sn(n,s,e);else{let t=r.tn(s.kind);i_.xt.At(e,t)}}return this.Dn(n)}Rn(e,t,r){return this.Vn(e,t,r.position)}Dn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].Yt();return t}Sn(e,t,r){let n=[...e],i=[];for(let e of r.arrayValue.values||[])for(let r of n){let n=new iD;n.seed(r.Yt()),i_.xt.At(e,n.tn(t.kind)),i.push(n)}return i}bn(e,t){return!!e.filters.find(e=>e instanceof rf&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let r=tw(e,e4),n=tw(e,e6);return(t?r.G(e3,IDBKeyRange.bound(t,t)):r.G()).next(e=>{let t=[];return ea.forEach(e,e=>n.get([e.indexId,this.uid]).next(r=>{t.push(function(e,t){let r=t?new J(t.sequenceNumber,new et(id(t.readTime),new Q(eS(t.documentKey)),t.largestBatchId)):J.empty(),n=e.fields.map(([e,t])=>new Z(j.fromServerFormat(e),t));return new H(e.indexId,e.collectionGroup,n,r)}(e,r))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let r=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==r?r:P(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,r){let n=tw(e,e4),i=tw(e,e6);return this.vn(e).next(e=>n.G(e3,IDBKeyRange.bound(t,t)).next(t=>ea.forEach(t,t=>i.put(iI(t.indexId,this.uid,e,r)))))}updateIndexEntries(e,t){let r=new Map;return ea.forEach(t,(t,n)=>{let i=r.get(t.collectionGroup);return(i?ea.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(r.set(t.collectionGroup,i),ea.forEach(i,r=>this.Cn(e,t,r).next(t=>{let i=this.Fn(n,r);return t.isEqual(i)?ea.resolve():this.Mn(e,n,r,t,i)}))))})}xn(e,t,r,n){return tw(e,tt).put({indexId:n.indexId,uid:this.uid,arrayValue:n.arrayValue,directionalValue:n.directionalValue,orderedDocumentKey:this.wn(r,t.key),documentKey:t.key.path.toArray()})}On(e,t,r,n){return tw(e,tt).delete([n.indexId,this.uid,n.arrayValue,n.directionalValue,this.wn(r,t.key),t.key.path.toArray()])}Cn(e,t,r){let n=tw(e,tt),i=new tx(iA);return n.Z({index:tn,range:IDBKeyRange.only([r.indexId,this.uid,this.wn(r,t)])},(e,n)=>{i=i.add(new iC(r.indexId,t,n.arrayValue,n.directionalValue))}).next(()=>i)}Fn(e,t){let r=new tx(iA),n=this.yn(t,e);if(null==n)return r;let i=W(t);if(null!=i){let s=e.data.field(i.fieldPath);if(t3(s))for(let i of s.arrayValue.values||[])r=r.add(new iC(t.indexId,e.key,this.fn(i),n))}else r=r.add(new iC(t.indexId,e.key,iz,n));return r}Mn(e,t,r,n,i){T(iK,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,r,n,i){let s=e.getIterator(),a=t.getIterator(),o=tN(s),l=tN(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let n=r(o,l);n<0?t=!0:n>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(n(l),l=tN(a)):t?(i(o),o=tN(s)):(o=tN(s),l=tN(a))}}(n,i,iA,n=>{s.push(this.xn(e,t,r,n))},n=>{s.push(this.On(e,t,r,n))}),ea.waitFor(s)}vn(e){let t=1;return tw(e,e6).Z({index:e7,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,r,n)=>{n.done(),t=r.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((e,t)=>iA(e,t)).filter((e,t,r)=>!t||0!==iA(e,r[t-1]));let n=[];for(let i of(n.push(e),r)){let r=iA(i,e),s=iA(i,t);if(0===r)n[0]=e.nn();else if(r>0&&s<0)n.push(i),n.push(i.nn());else if(s>0)break}n.push(t);let i=[];for(let e=0;e<n.length;e+=2){if(this.Nn(n[e],n[e+1]))return[];let t=[n[e].indexId,this.uid,n[e].arrayValue,n[e].directionalValue,iz,[]],r=[n[e+1].indexId,this.uid,n[e+1].arrayValue,n[e+1].directionalValue,iz,[]];i.push(IDBKeyRange.bound(t,r))}return i}Nn(e,t){return iA(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(iG)}getMinOffset(e,t){return ea.mapArray(this.dn(t),t=>this.An(e,t).next(e=>e||x())).next(iG)}}function iG(e){0!==e.length||x();let t=e[0].indexState.offset,r=t.largestBatchId;for(let n=1;n<e.length;n++){let i=e[n].indexState.offset;0>er(i,t)&&(t=i),r<i.largestBatchId&&(r=i.largestBatchId)}return new et(t.readTime,t.documentKey,r)}let ij={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class iQ{static withCacheSize(e){return new iQ(e,iQ.DEFAULT_COLLECTION_PERCENTILE,iQ.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}}function iH(e,t,r){let n=e.store(eA),i=e.store(eL),s=[],a=IDBKeyRange.only(r.batchId),o=0,l=n.Z({range:a},(e,t,r)=>(o++,r.delete()));s.push(l.next(()=>{1===o||x()}));let u=[];for(let e of r.mutations){var h,c;let n=(h=e.key.path,c=r.batchId,[t,ex(h),c]);s.push(i.delete(n)),u.push(e.key)}return ea.waitFor(s).next(()=>u)}function iW(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw x();t=e.noDocument}return JSON.stringify(t).length}iQ.DEFAULT_COLLECTION_PERCENTILE=10,iQ.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,iQ.DEFAULT=new iQ(0x2800000,iQ.DEFAULT_COLLECTION_PERCENTILE,iQ.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),iQ.DISABLED=new iQ(-1,0,0);class iY{constructor(e,t,r,n){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=n,this.Bn={}}static It(e,t,r,n){return""!==e.uid||x(),new iY(e.isAuthenticated()?e.uid:"",t,r,n)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return iJ(e).Z({index:eR,range:r},(e,r,n)=>{t=!1,n.done()}).next(()=>t)}addMutationBatch(e,t,r,n){let i=tw(e,eL),s=iJ(e);return s.add({}).next(a=>{"number"==typeof a||x();let o=new n_(a,t,r,n),l=function(e,t,r){let n=r.baseMutations.map(t=>n9(e.Tt,t)),i=r.mutations.map(t=>n9(e.Tt,t));return{userId:t,batchId:r.batchId,localWriteTimeMs:r.localWriteTime.toMillis(),baseMutations:n,mutations:i}}(this.serializer,this.userId,o),u=[],h=new tx((e,t)=>P(e.canonicalString(),t.canonicalString()));for(let e of n){let t=[this.userId,ex(e.key.path),a];h=h.add(e.key.path.popLast()),u.push(s.put(l)),u.push(i.put(t,eM))}return h.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Bn[a]=o.keys()}),ea.waitFor(u).next(()=>o)})}lookupMutationBatch(e,t){return iJ(e).get(t).next(e=>e?(e.userId===this.userId||x(),im(this.serializer,e)):null)}Ln(e,t){return this.Bn[t]?ea.resolve(this.Bn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let r=e.keys();return this.Bn[t]=r,r}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]),i=null;return iJ(e).Z({index:eR,range:n},(e,t,n)=>{t.userId===this.userId&&(t.batchId>=r||x(),i=im(this.serializer,t)),n.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return iJ(e).Z({index:eR,range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return iJ(e).G(eR,t).next(e=>e.map(e=>im(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=[this.userId,ex(t.path)],n=IDBKeyRange.lowerBound(r),i=[];return tw(e,eL).Z({range:n},(r,n,s)=>{let[a,o,l]=r,u=eS(o);if(a===this.userId&&t.path.isEqual(u))return iJ(e).get(l).next(e=>{if(!e)throw x();e.userId===this.userId||x(),i.push(im(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new tx(P),n=[];return t.forEach(t=>{let i=[this.userId,ex(t.path)],s=IDBKeyRange.lowerBound(i),a=tw(e,eL).Z({range:s},(e,n,i)=>{let[s,a,o]=e,l=eS(a);s===this.userId&&t.path.isEqual(l)?r=r.add(o):i.done()});n.push(a)}),ea.waitFor(n).next(()=>this.kn(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,n=r.length+1,i=[this.userId,ex(r)],s=IDBKeyRange.lowerBound(i),a=new tx(P);return tw(e,eL).Z({range:s},(e,t,i)=>{let[s,o,l]=e,u=eS(o);s===this.userId&&r.isPrefixOf(u)?u.length===n&&(a=a.add(l)):i.done()}).next(()=>this.kn(e,a))}kn(e,t){let r=[],n=[];return t.forEach(t=>{n.push(iJ(e).get(t).next(e=>{if(null===e)throw x();e.userId===this.userId||x(),r.push(im(this.serializer,e))}))}),ea.waitFor(n).next(()=>r)}removeMutationBatch(e,t){return iH(e.ue,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.qn(t.batchId)}),ea.forEach(r,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}qn(e){delete this.Bn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ea.resolve();let r=IDBKeyRange.lowerBound([this.userId]),n=[];return tw(e,eL).Z({range:r},(e,t,r)=>{if(e[0]===this.userId){let t=eS(e[1]);n.push(t)}else r.done()}).next(()=>{0===n.length||x()})})}containsKey(e,t){return iZ(e,this.userId,t)}Qn(e){return tw(e,eC).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function iZ(e,t,r){let n=[t,ex(r.path)],i=n[1],s=IDBKeyRange.lowerBound(n),a=!1;return tw(e,eL).Z({range:s,Y:!0},(e,r,n)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),n.done()}).next(()=>a)}function iJ(e){return tw(e,eA)}class iX{constructor(e){this.$n=e}next(){return this.$n+=2,this.$n}static Kn(){return new iX(0)}static Un(){return new iX(-1)}}class i0{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Wn(e).next(t=>{let r=new iX(t.highestTargetId);return t.highestTargetId=r.next(),this.Gn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Wn(e).next(e=>B.fromTimestamp(new q(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Wn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.Wn(e).next(n=>(n.highestListenSequenceNumber=t,r&&(n.lastRemoteSnapshotVersion=r.toTimestamp()),t>n.highestListenSequenceNumber&&(n.highestListenSequenceNumber=t),this.Gn(e,n)))}addTargetData(e,t){return this.zn(e,t).next(()=>this.Wn(e).next(r=>(r.targetCount+=1,this.jn(t,r),this.Gn(e,r))))}updateTargetData(e,t){return this.zn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tw(e,eG).delete(t.targetId)).next(()=>this.Wn(e)).next(t=>(t.targetCount>0||x(),t.targetCount-=1,this.Gn(e,t)))}removeTargets(e,t,r){let n=0,i=[];return tw(e,eG).Z((s,a)=>{let o=ig(a);o.sequenceNumber<=t&&null===r.get(o.targetId)&&(n++,i.push(this.removeTargetData(e,o)))}).next(()=>ea.waitFor(i)).next(()=>n)}forEachTarget(e,t){return tw(e,eG).Z((e,r)=>{t(ig(r))})}Wn(e){return tw(e,eX).get(eJ).next(e=>(null!==e||x(),e))}Gn(e,t){return tw(e,eX).put(eJ,t)}zn(e,t){return tw(e,eG).put(ip(this.serializer,t))}jn(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.Wn(e).next(e=>e.targetCount)}getTargetData(e,t){let r=rC(t),n=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),i=null;return tw(e,eG).Z({range:n,index:ej},(e,r,n)=>{let s=ig(r);rA(t,s.target)&&(i=s,n.done())}).next(()=>i)}addMatchingKeys(e,t,r){let n=[],i=i1(e);return t.forEach(t=>{let s=ex(t.path);n.push(i.put({targetId:r,path:s})),n.push(this.referenceDelegate.addReference(e,r,t))}),ea.waitFor(n)}removeMatchingKeys(e,t,r){let n=i1(e);return ea.forEach(t,t=>{let i=ex(t.path);return ea.waitFor([n.delete([r,i]),this.referenceDelegate.removeReference(e,r,t)])})}removeMatchingKeysForTargetId(e,t){let r=i1(e),n=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(n)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),n=i1(e),i=r8();return n.Z({range:r,Y:!0},(e,t,r)=>{let n=new Q(eS(e[1]));i=i.add(n)}).next(()=>i)}containsKey(e,t){let r=ex(t.path),n=IDBKeyRange.bound([r],[r+"\0"],!1,!0),i=0;return i1(e).Z({index:eY,Y:!0,range:n},([e,t],r,n)=>{0!==e&&(i++,n.done())}).next(()=>i>0)}lt(e,t){return tw(e,eG).get(t).next(e=>e?ig(e):null)}}function i1(e){return tw(e,eH)}let i2="LruGarbageCollector";function i5([e,t],[r,n]){let i=P(e,r);return 0===i?P(t,n):i}class i8{constructor(e){this.Hn=e,this.buffer=new tx(i5),this.Jn=0}Yn(){return++this.Jn}Zn(e){let t=[e,this.Yn()];if(this.buffer.size<this.Hn)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>i5(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class i4{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.Xn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.er(6e4)}stop(){this.Xn&&(this.Xn.cancel(),this.Xn=null)}get started(){return null!==this.Xn}er(e){T(i2,`Garbage collection scheduled in ${e}ms`),this.Xn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Xn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ef(e)?T(i2,"Ignoring IndexedDB error during garbage collection: ",e):await es(e)}await this.er(3e5)})}}class i3{constructor(e,t){this.tr=e,this.params=t}calculateTargetCount(e,t){return this.tr.nr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ea.resolve(eT.ae);let r=new i8(t);return this.tr.forEachTarget(e,e=>r.Zn(e.sequenceNumber)).next(()=>this.tr.rr(e,e=>r.Zn(e))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.tr.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.tr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector","Garbage collection skipped; disabled"),ea.resolve(ij)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ij):this.ir(e,t))}getCacheSize(e){return this.tr.getCacheSize(e)}ir(e,t){let r,n,i,s,a,o,l;let h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(T("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),n=this.params.maximumSequenceNumbersToCollect):n=t,s=Date.now(),this.nthSequenceNumber(e,n))).next(n=>(r=n,a=Date.now(),this.removeTargets(e,r,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,r))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&T("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${n} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),ea.resolve({didRun:!0,sequenceNumbersCollected:n,targetsRemoved:i,documentsRemoved:e})))}}class i6{constructor(e,t){this.db=e,this.garbageCollector=new i3(this,t)}nr(e){let t=this.sr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}rr(e,t){return this._r(e,(e,r)=>t(r))}addReference(e,t,r){return i9(e,r)}removeReference(e,t,r){return i9(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return i9(e,t)}ar(e,t){let r;return r=!1,tw(e,eC).X(n=>iZ(e,n,t).next(e=>(e&&(r=!0),ea.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),n=[],i=0;return this._r(e,(s,a)=>{if(a<=t){let t=this.ar(e,s).next(t=>{if(!t)return i++,r.getEntry(e,s).next(()=>(r.removeEntry(s,B.min()),i1(e).delete([0,ex(s.path)])))});n.push(t)}}).next(()=>ea.waitFor(n)).next(()=>r.apply(e)).next(()=>i)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return i9(e,t)}_r(e,t){let r=i1(e),n,i=eT.ae;return r.Z({index:eY},([e,r],{path:s,sequenceNumber:a})=>{0===e?(i!==eT.ae&&t(new Q(eS(n)),i),i=a,n=s):i=eT.ae}).next(()=>{i!==eT.ae&&t(new Q(eS(n)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function i9(e,t){var r;return i1(e).put((r=e.currentSequenceNumber,{targetId:0,path:ex(t.path),sequenceNumber:r}))}class i7{constructor(){this.changes=new rY(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ro.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return void 0!==r?ea.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class se{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return tw(e,eF).put(r)}removeEntry(e,t,r){return tw(e,eF).delete(function(e,t){let r=e.path.toArray();return[r.slice(0,r.length-2),r[r.length-2],ih(t),r[r.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.ur(e,r)))}getEntry(e,t){let r=ro.newInvalidDocument(t);return tw(e,eF).Z({index:eU,range:IDBKeyRange.only(sr(t))},(e,n)=>{r=this.cr(t,n)}).next(()=>r)}lr(e,t){let r={size:0,document:ro.newInvalidDocument(t)};return tw(e,eF).Z({index:eU,range:IDBKeyRange.only(sr(t))},(e,n)=>{r={document:this.cr(t,n),size:iW(n)}}).next(()=>r)}getEntries(e,t){let r=rZ;return this.hr(e,t,(e,t)=>{let n=this.cr(e,t);r=r.insert(e,n)}).next(()=>r)}Pr(e,t){let r=rZ,n=new tE(Q.comparator);return this.hr(e,t,(e,t)=>{let i=this.cr(e,t);r=r.insert(e,i),n=n.insert(e,iW(t))}).next(()=>({documents:r,Tr:n}))}hr(e,t,r){if(t.isEmpty())return ea.resolve();let n=new tx(si);t.forEach(e=>n=n.add(e));let i=IDBKeyRange.bound(sr(n.first()),sr(n.last())),s=n.getIterator(),a=s.getNext();return tw(e,eF).Z({index:eU,range:i},(e,t,n)=>{let i=Q.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>si(a,i);)r(a,null),a=s.getNext();a&&a.isEqual(i)&&(r(a,t),a=s.hasNext()?s.getNext():null),a?n.W(sr(a)):n.done()}).next(()=>{for(;a;)r(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,r,n,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),ih(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tw(e,eF).G(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let r=rZ;for(let i of e){let e=this.cr(Q.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(rQ(t,e)||n.has(e.key))&&(r=r.insert(e.key,e))}return r})}getAllFromCollectionGroup(e,t,r,n){let i=rZ,s=sn(t,r),a=sn(t,et.max());return tw(e,eF).Z({index:eB,range:IDBKeyRange.bound(s,a,!0)},(e,t,r)=>{let s=this.cr(Q.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===n&&r.done()}).next(()=>i)}newChangeBuffer(e){return new st(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tw(e,ez).get(e$).next(e=>(e||x(),e))}ur(e,t){return tw(e,ez).put(e$,t)}cr(e,t){if(t){let e=function(e,t){let r;if(t.document)r=n6(e.Tt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=Q.fromSegments(t.noDocument.path),n=id(t.noDocument.readTime);r=ro.newNoDocument(e,n),t.hasCommittedMutations&&r.setHasCommittedMutations()}else{if(!t.unknownDocument)return x();{let e=Q.fromSegments(t.unknownDocument.path),n=id(t.unknownDocument.version);r=ro.newUnknownDocument(e,n)}}return t.readTime&&r.setReadTime(function(e){let t=new q(e[0],e[1]);return B.fromTimestamp(t)}(t.readTime)),r}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(B.min())))return e}return ro.newInvalidDocument(e)}}class st extends i7{constructor(e,t){super(),this.Ir=e,this.trackRemovals=t,this.Er=new rY(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],r=0,n=new tx((e,t)=>P(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Er.get(i);if(t.push(this.Ir.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=iu(this.Ir.serializer,s);n=n.add(i.path.popLast());let l=iW(o);r+=l-a.size,t.push(this.Ir.addEntry(e,i,o))}else if(r-=a.size,this.trackRemovals){let r=iu(this.Ir.serializer,s.convertToNoDocument(B.min()));t.push(this.Ir.addEntry(e,i,r))}}),n.forEach(r=>{t.push(this.Ir.indexManager.addToCollectionParentIndex(e,r))}),t.push(this.Ir.updateMetadata(e,r)),ea.waitFor(t)}getFromCache(e,t){return this.Ir.lr(e,t).next(e=>(this.Er.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Ir.Pr(e,t).next(({documents:e,Tr:t})=>(t.forEach((t,r)=>{this.Er.set(t,{size:r,readTime:e.get(t).readTime})}),e))}}function sr(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sn(e,t){let r=t.documentKey.path.toArray();return[e,ih(t.readTime),r.slice(0,r.length-2),r.length>0?r[r.length-1]:""]}function si(e,t){let r=e.path.toArray(),n=t.path.toArray(),i=0;for(let e=0;e<r.length-2&&e<n.length-2;++e)if(i=P(r[e],n[e]))return i;return(i=P(r.length,n.length))||(i=P(r[r.length-2],n[n.length-2]))||P(r[r.length-1],n[n.length-1])}class ss{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sa{constructor(e,t,r,n){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=n}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(n=>(r=n,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==r&&ng(r.mutation,e,tk.empty(),q.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,r8()).next(()=>t))}getLocalViewOfDocuments(e,t,r=r8()){let n=r1();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,r).next(e=>{let t=rX();return e.forEach((e,r)=>{t=t.insert(e,r.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let r=r1();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,r8()))}populateOverlays(e,t,r){let n=[];return r.forEach(e=>{t.has(e)||n.push(e)}),this.documentOverlayCache.getOverlays(e,n).next(e=>{e.forEach((e,r)=>{t.set(e,r)})})}computeViews(e,t,r,n){let i=rZ,s=r1(),a=r1();return t.forEach((e,t)=>{let a=r.get(t.key);n.has(t.key)&&(void 0===a||a.mutation instanceof nw)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),ng(a.mutation,t,a.mutation.getFieldMask(),q.now())):s.set(t.key,tk.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var r;return a.set(e,new ss(t,null!==(r=s.get(e))&&void 0!==r?r:null))}),a))}recalculateAndSaveOverlays(e,t){let r=r1(),n=new tE((e,t)=>e-t),i=r8();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=r.get(e)||tk.empty();a=i.applyToLocalView(s,a),r.set(e,a);let o=(n.get(i.batchId)||r8()).add(e);n=n.insert(i.batchId,o)})}).next(()=>{let s=[],a=n.getReverseIterator();for(;a.hasNext();){let n=a.getNext(),o=n.key,l=n.value,u=r1();l.forEach(e=>{if(!i.has(e)){let n=nm(t.get(e),r.get(e));null!==n&&u.set(e,n),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ea.waitFor(s)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,r,n){return Q.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):rU(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,n):this.getDocumentsMatchingCollectionQuery(e,t,r,n)}getNextDocuments(e,t,r,n){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,n).next(i=>{let s=n-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,n-i.size):ea.resolve(r1()),a=-1,o=i;return s.next(t=>ea.forEach(t,(t,r)=>(a<r.largestBatchId&&(a=r.largestBatchId),i.get(t)?ea.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,r8())).next(e=>({batchId:a,changes:r0(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new Q(t)).next(e=>{let t=rX();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,r,n){let i=t.collectionGroup,s=rX();return this.indexManager.getCollectionParents(e,i).next(a=>ea.forEach(a,a=>{let o=new rL(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,r,n).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,r,n){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,i,n))).next(e=>{i.forEach((t,r)=>{let n=r.getKey();null===e.get(n)&&(e=e.insert(n,ro.newInvalidDocument(n)))});let r=rX();return e.forEach((e,n)=>{let s=i.get(e);void 0!==s&&ng(s.mutation,n,tk.empty(),q.now()),rQ(t,n)&&(r=r.insert(e,n))}),r})}}class so{constructor(e){this.serializer=e,this.dr=new Map,this.Ar=new Map}getBundleMetadata(e,t){return ea.resolve(this.dr.get(t))}saveBundleMetadata(e,t){return this.dr.set(t.id,{id:t.id,version:t.version,createTime:nY(t.createTime)}),ea.resolve()}getNamedQuery(e,t){return ea.resolve(this.Ar.get(t))}saveNamedQuery(e,t){return this.Ar.set(t.name,{name:t.name,query:iy(t.bundledQuery),readTime:nY(t.readTime)}),ea.resolve()}}class sl{constructor(){this.overlays=new tE(Q.comparator),this.Rr=new Map}getOverlay(e,t){return ea.resolve(this.overlays.get(t))}getOverlays(e,t){let r=r1();return ea.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&r.set(t,e)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((r,n)=>{this.Et(e,t,n)}),ea.resolve()}removeOverlaysForBatchId(e,t,r){let n=this.Rr.get(r);return void 0!==n&&(n.forEach(e=>this.overlays=this.overlays.remove(e)),this.Rr.delete(r)),ea.resolve()}getOverlaysForCollection(e,t,r){let n=r1(),i=t.length+1,s=new Q(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>r&&n.set(e.getKey(),e)}return ea.resolve(n)}getOverlaysForCollectionGroup(e,t,r,n){let i=new tE((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>r){let t=i.get(e.largestBatchId);null===t&&(t=r1(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=r1(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=n)););return ea.resolve(a)}Et(e,t,r){let n=this.overlays.get(r.key);if(null!==n){let e=this.Rr.get(n.largestBatchId).delete(r.key);this.Rr.set(n.largestBatchId,e)}this.overlays=this.overlays.insert(r.key,new nS(t,r));let i=this.Rr.get(t);void 0===i&&(i=r8(),this.Rr.set(t,i)),this.Rr.set(t,i.add(r.key))}}class su{constructor(){this.sessionToken=tC.EMPTY_BYTE_STRING}getSessionToken(e){return ea.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ea.resolve()}}class sh{constructor(){this.Vr=new tx(sc.mr),this.gr=new tx(sc.pr)}isEmpty(){return this.Vr.isEmpty()}addReference(e,t){let r=new sc(e,t);this.Vr=this.Vr.add(r),this.gr=this.gr.add(r)}yr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.wr(new sc(e,t))}br(e,t){e.forEach(e=>this.removeReference(e,t))}Sr(e){let t=new Q(new $([])),r=new sc(t,e),n=new sc(t,e+1),i=[];return this.gr.forEachInRange([r,n],e=>{this.wr(e),i.push(e.key)}),i}Dr(){this.Vr.forEach(e=>this.wr(e))}wr(e){this.Vr=this.Vr.delete(e),this.gr=this.gr.delete(e)}vr(e){let t=new Q(new $([])),r=new sc(t,e),n=new sc(t,e+1),i=r8();return this.gr.forEachInRange([r,n],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sc(e,0),r=this.Vr.firstAfterOrEqual(t);return null!==r&&e.isEqual(r.key)}}class sc{constructor(e,t){this.key=e,this.Cr=t}static mr(e,t){return Q.comparator(e.key,t.key)||P(e.Cr,t.Cr)}static pr(e,t){return P(e.Cr,t.Cr)||Q.comparator(e.key,t.key)}}class sd{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Fr=1,this.Mr=new tx(sc.mr)}checkEmpty(e){return ea.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,r,n){let i=this.Fr;this.Fr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new n_(i,t,r,n);for(let t of(this.mutationQueue.push(s),n))this.Mr=this.Mr.add(new sc(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ea.resolve(s)}lookupMutationBatch(e,t){return ea.resolve(this.Or(t))}getNextMutationBatchAfterBatchId(e,t){let r=this.Nr(t+1),n=r<0?0:r;return ea.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return ea.resolve(0===this.mutationQueue.length?-1:this.Fr-1)}getAllMutationBatches(e){return ea.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new sc(t,0),n=new sc(t,Number.POSITIVE_INFINITY),i=[];return this.Mr.forEachInRange([r,n],e=>{let t=this.Or(e.Cr);i.push(t)}),ea.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new tx(P);return t.forEach(e=>{let t=new sc(e,0),n=new sc(e,Number.POSITIVE_INFINITY);this.Mr.forEachInRange([t,n],e=>{r=r.add(e.Cr)})}),ea.resolve(this.Br(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,n=r.length+1,i=r;Q.isDocumentKey(i)||(i=i.child(""));let s=new sc(new Q(i),0),a=new tx(P);return this.Mr.forEachWhile(e=>{let t=e.key.path;return!!r.isPrefixOf(t)&&(t.length===n&&(a=a.add(e.Cr)),!0)},s),ea.resolve(this.Br(a))}Br(e){let t=[];return e.forEach(e=>{let r=this.Or(e);null!==r&&t.push(r)}),t}removeMutationBatch(e,t){0===this.Lr(t.batchId,"removed")||x(),this.mutationQueue.shift();let r=this.Mr;return ea.forEach(t.mutations,n=>{let i=new sc(n.key,t.batchId);return r=r.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,n.key)}).next(()=>{this.Mr=r})}qn(e){}containsKey(e,t){let r=new sc(t,0),n=this.Mr.firstAfterOrEqual(r);return ea.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,ea.resolve()}Lr(e,t){return this.Nr(e)}Nr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Or(e){let t=this.Nr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sf{constructor(e){this.kr=e,this.docs=new tE(Q.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,n=this.docs.get(r),i=n?n.size:0,s=this.kr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return ea.resolve(r?r.document.mutableCopy():ro.newInvalidDocument(t))}getEntries(e,t){let r=rZ;return t.forEach(e=>{let t=this.docs.get(e);r=r.insert(e,t?t.document.mutableCopy():ro.newInvalidDocument(e))}),ea.resolve(r)}getDocumentsMatchingQuery(e,t,r,n){let i=rZ,s=t.path,a=new Q(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=er(ee(a),r)||(n.has(a.key)||rQ(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ea.resolve(i)}getAllFromCollectionGroup(e,t,r,n){x()}qr(e,t){return ea.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sm(this)}getSize(e){return ea.resolve(this.size)}}class sm extends i7{constructor(e){super(),this.Ir=e}applyChanges(e){let t=[];return this.changes.forEach((r,n)=>{n.isValidDocument()?t.push(this.Ir.addEntry(e,n)):this.Ir.removeEntry(r)}),ea.waitFor(t)}getFromCache(e,t){return this.Ir.getEntry(e,t)}getAllFromCache(e,t){return this.Ir.getEntries(e,t)}}class sg{constructor(e){this.persistence=e,this.Qr=new rY(e=>rC(e),rA),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.$r=0,this.Kr=new sh,this.targetCount=0,this.Ur=iX.Kn()}forEachTarget(e,t){return this.Qr.forEach((e,r)=>t(r)),ea.resolve()}getLastRemoteSnapshotVersion(e){return ea.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ea.resolve(this.$r)}allocateTargetId(e){return this.highestTargetId=this.Ur.next(),ea.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.$r&&(this.$r=t),ea.resolve()}zn(e){this.Qr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.Ur=new iX(t),this.highestTargetId=t),e.sequenceNumber>this.$r&&(this.$r=e.sequenceNumber)}addTargetData(e,t){return this.zn(t),this.targetCount+=1,ea.resolve()}updateTargetData(e,t){return this.zn(t),ea.resolve()}removeTargetData(e,t){return this.Qr.delete(t.target),this.Kr.Sr(t.targetId),this.targetCount-=1,ea.resolve()}removeTargets(e,t,r){let n=0,i=[];return this.Qr.forEach((s,a)=>{a.sequenceNumber<=t&&null===r.get(a.targetId)&&(this.Qr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),n++)}),ea.waitFor(i).next(()=>n)}getTargetCount(e){return ea.resolve(this.targetCount)}getTargetData(e,t){let r=this.Qr.get(t)||null;return ea.resolve(r)}addMatchingKeys(e,t,r){return this.Kr.yr(t,r),ea.resolve()}removeMatchingKeys(e,t,r){this.Kr.br(t,r);let n=this.persistence.referenceDelegate,i=[];return n&&t.forEach(t=>{i.push(n.markPotentiallyOrphaned(e,t))}),ea.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Kr.Sr(t),ea.resolve()}getMatchingKeysForTargetId(e,t){let r=this.Kr.vr(t);return ea.resolve(r)}containsKey(e,t){return ea.resolve(this.Kr.containsKey(t))}}class sp{constructor(e,t){this.Wr={},this.overlays={},this.Gr=new eT(0),this.zr=!1,this.zr=!0,this.jr=new su,this.referenceDelegate=e(this),this.Hr=new sg(this),this.indexManager=new iq,this.remoteDocumentCache=new sf(e=>this.referenceDelegate.Jr(e)),this.serializer=new il(t),this.Yr=new so(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.zr=!1,Promise.resolve()}get started(){return this.zr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sl,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.Wr[e.toKey()];return r||(r=new sd(t,this.referenceDelegate),this.Wr[e.toKey()]=r),r}getGlobalsCache(){return this.jr}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Yr}runTransaction(e,t,r){T("MemoryPersistence","Starting transaction:",e);let n=new sy(this.Gr.next());return this.referenceDelegate.Zr(),r(n).next(e=>this.referenceDelegate.Xr(n).next(()=>e)).toPromise().then(e=>(n.raiseOnCommittedEvent(),e))}ei(e,t){return ea.or(Object.values(this.Wr).map(r=>()=>r.containsKey(e,t)))}}class sy extends ei{constructor(e){super(),this.currentSequenceNumber=e}}class sw{constructor(e){this.persistence=e,this.ti=new sh,this.ni=null}static ri(e){return new sw(e)}get ii(){if(this.ni)return this.ni;throw x()}addReference(e,t,r){return this.ti.addReference(r,t),this.ii.delete(r.toString()),ea.resolve()}removeReference(e,t,r){return this.ti.removeReference(r,t),this.ii.add(r.toString()),ea.resolve()}markPotentiallyOrphaned(e,t){return this.ii.add(t.toString()),ea.resolve()}removeTarget(e,t){this.ti.Sr(t.targetId).forEach(e=>this.ii.add(e.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.ii.add(e.toString()))}).next(()=>r.removeTargetData(e,t))}Zr(){this.ni=new Set}Xr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ea.forEach(this.ii,r=>{let n=Q.fromPath(r);return this.si(e,n).next(e=>{e||t.removeEntry(n,B.min())})}).next(()=>(this.ni=null,t.apply(e)))}updateLimboDocument(e,t){return this.si(e,t).next(e=>{e?this.ii.delete(t.toString()):this.ii.add(t.toString())})}Jr(e){return 0}si(e,t){return ea.or([()=>ea.resolve(this.ti.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.ei(e,t)])}}class sv{constructor(e,t){this.persistence=e,this.oi=new rY(e=>ex(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new i3(this,t)}static ri(e,t){return new sv(e,t)}Zr(){}Xr(e){return ea.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}nr(e){let t=this.sr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}rr(e,t){return ea.forEach(this.oi,(r,n)=>this.ar(e,r,n).next(e=>e?ea.resolve():t(n)))}removeTargets(e,t,r){return this.persistence.getTargetCache().removeTargets(e,t,r)}removeOrphanedDocuments(e,t){let r=0,n=this.persistence.getRemoteDocumentCache(),i=n.newChangeBuffer();return n.qr(e,n=>this.ar(e,n,t).next(e=>{e||(r++,i.removeEntry(n,B.min()))})).next(()=>i.apply(e)).next(()=>r)}markPotentiallyOrphaned(e,t){return this.oi.set(t,e.currentSequenceNumber),ea.resolve()}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,r)}addReference(e,t,r){return this.oi.set(r,e.currentSequenceNumber),ea.resolve()}removeReference(e,t,r){return this.oi.set(r,e.currentSequenceNumber),ea.resolve()}updateLimboDocument(e,t){return this.oi.set(t,e.currentSequenceNumber),ea.resolve()}Jr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(tZ(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let r=tq(t);return r?16+e(r):16;case 5:return 2*t.stringValue.length;case 6:return tO(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,r)=>t+e(r),0);case 10:case 11:var n;let i;return n=t.mapValue,i=0,tI(n.fields,(t,r)=>{i+=t.length+e(r)}),i;default:throw x()}}(e.data.value)),t}ar(e,t,r){return ea.or([()=>this.persistence.ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.oi.get(t);return ea.resolve(void 0!==e&&e>r)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sI{constructor(e){this.serializer=e}B(e,t,r,n){let i=new el("createOrUpgrade",t);r<1&&n>=1&&(!function(e){e.createObjectStore(ek)}(e),e.createObjectStore(eC,{keyPath:"userId"}),e.createObjectStore(eA,{keyPath:eV,autoIncrement:!0}).createIndex(eR,eO,{unique:!0}),e.createObjectStore(eL),sT(e),function(e){e.createObjectStore(eN)}(e));let s=ea.resolve();return r<3&&n>=3&&(0!==r&&(e.deleteObjectStore(eH),e.deleteObjectStore(eG),e.deleteObjectStore(eX),sT(e)),s=s.next(()=>(function(e){let t=e.store(eX),r={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:B.min().toTimestamp(),targetCount:0};return t.put(eJ,r)})(i))),r<4&&n>=4&&(0!==r&&(s=s.next(()=>i.store(eA).G().next(t=>{e.deleteObjectStore(eA),e.createObjectStore(eA,{keyPath:eV,autoIncrement:!0}).createIndex(eR,eO,{unique:!0});let r=i.store(eA),n=t.map(e=>r.put(e));return ea.waitFor(n)}))),s=s.next(()=>{!function(e){e.createObjectStore(e2,{keyPath:"clientId"})}(e)})),r<5&&n>=5&&(s=s.next(()=>this._i(i))),r<6&&n>=6&&(s=s.next(()=>((function(e){e.createObjectStore(ez)})(e),this.ai(i)))),r<7&&n>=7&&(s=s.next(()=>this.ui(i))),r<8&&n>=8&&(s=s.next(()=>this.ci(e,i))),r<9&&n>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),r<10&&n>=10&&(s=s.next(()=>this.li(i))),r<11&&n>=11&&(s=s.next(()=>{(function(e){e.createObjectStore(e5,{keyPath:"bundleId"})})(e),function(e){e.createObjectStore(e8,{keyPath:"name"})}(e)})),r<12&&n>=12&&(s=s.next(()=>{!function(e){let t=e.createObjectStore(ts,{keyPath:ta});t.createIndex(to,tl,{unique:!1}),t.createIndex(tu,th,{unique:!1})}(e)})),r<13&&n>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eF,{keyPath:eP});t.createIndex(eU,eq),t.createIndex(eB,eK)})(e)).next(()=>this.hi(e,i)).next(()=>e.deleteObjectStore(eN))),r<14&&n>=14&&(s=s.next(()=>this.Pi(e,i))),r<15&&n>=15&&(s=s.next(()=>{e.createObjectStore(e4,{keyPath:"indexId",autoIncrement:!0}).createIndex(e3,"collectionGroup",{unique:!1}),e.createObjectStore(e6,{keyPath:e9}).createIndex(e7,te,{unique:!1}),e.createObjectStore(tt,{keyPath:tr}).createIndex(tn,ti,{unique:!1})})),r<16&&n>=16&&(s=s.next(()=>{t.objectStore(e6).clear()}).next(()=>{t.objectStore(tt).clear()})),r<17&&n>=17&&(s=s.next(()=>{!function(e){e.createObjectStore(tc,{keyPath:"name"})}(e)})),s}ai(e){let t=0;return e.store(eN).Z((e,r)=>{t+=iW(r)}).next(()=>{let r={byteSize:t};return e.store(ez).put(e$,r)})}_i(e){let t=e.store(eC),r=e.store(eA);return t.G().next(t=>ea.forEach(t,t=>{let n=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.G(eR,n).next(r=>ea.forEach(r,r=>{r.userId===t.userId||x();let n=im(this.serializer,r);return iH(e,t.userId,n).next(()=>{})}))}))}ui(e){let t=e.store(eH),r=e.store(eN);return e.store(eX).get(eJ).next(e=>{let n=[];return r.Z((r,i)=>{let s=new $(r),a=[0,ex(s)];n.push(t.get(a).next(r=>r?ea.resolve():t.put({targetId:0,path:ex(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ea.waitFor(n))})}ci(e,t){e.createObjectStore(e0,{keyPath:e1});let r=t.store(e0),n=new iB,i=e=>{if(n.add(e)){let t=e.lastSegment(),n=e.popLast();return r.put({collectionId:t,parent:ex(n)})}};return t.store(eN).Z({Y:!0},(e,t)=>i(new $(e).popLast())).next(()=>t.store(eL).Z({Y:!0},([e,t,r],n)=>i(eS(t).popLast())))}li(e){let t=e.store(eG);return t.Z((e,r)=>{let n=ig(r),i=ip(this.serializer,n);return t.put(i)})}hi(e,t){let r=t.store(eN),n=[];return r.Z((e,r)=>{let i=t.store(eF),s=(r.document?new Q($.fromString(r.document.name).popFirst(5)):r.noDocument?Q.fromSegments(r.noDocument.path):r.unknownDocument?Q.fromSegments(r.unknownDocument.path):x()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:r.readTime||[0,0],unknownDocument:r.unknownDocument,noDocument:r.noDocument,document:r.document,hasCommittedMutations:!!r.hasCommittedMutations};n.push(i.put(a))}).next(()=>ea.waitFor(n))}Pi(e,t){let r=t.store(eA),n=new se(this.serializer),i=new sp(sw.ri,this.serializer.Tt);return r.G().next(e=>{let r=new Map;return e.forEach(e=>{var t;let n=null!==(t=r.get(e.userId))&&void 0!==t?t:r8();im(this.serializer,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),ea.forEach(r,(e,r)=>{let s=new y(r),a=iE.It(this.serializer,s),o=i.getIndexManager(s);return new sa(n,iY.It(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new ty(t,eT.ae),e).next()})})}}function sT(e){e.createObjectStore(eH,{keyPath:eW}).createIndex(eY,eZ,{unique:!0}),e.createObjectStore(eG,{keyPath:"targetId"}).createIndex(ej,eQ,{unique:!0}),e.createObjectStore(eX)}let sE="IndexedDbPersistence",sb="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class s_{constructor(e,t,r,n,i,s,a,o,l,u,h=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.Ti=i,this.window=s,this.document=a,this.Ii=l,this.Ei=u,this.di=h,this.Gr=null,this.zr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ai=null,this.inForeground=!1,this.Ri=null,this.Vi=null,this.mi=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!s_.D())throw new N(S.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new i6(this,n),this.gi=t+"main",this.serializer=new il(o),this.pi=new eu(this.gi,this.di,new sI(this.serializer)),this.jr=new ib,this.Hr=new i0(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new se(this.serializer),this.Yr=new iT,this.window&&this.window.localStorage?this.yi=this.window.localStorage:(this.yi=null,!1===u&&E(sE,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new N(S.FAILED_PRECONDITION,sb);return this.bi(),this.Si(),this.Di(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Hr.getHighestSequenceNumber(e))}).then(e=>{this.Gr=new eT(e,this.Ii)}).then(()=>{this.zr=!0}).catch(e=>(this.pi&&this.pi.close(),Promise.reject(e)))}Ci(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.pi.k(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ti.enqueueAndForget(async()=>{this.started&&await this.wi()}))}wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tw(e,e2).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Fi(e).next(e=>{e||(this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)))})}).next(()=>this.Mi(e)).next(t=>this.isPrimary&&!t?this.xi(e).next(()=>!1):!!t&&this.Oi(e).next(()=>!0))).catch(e=>{if(ef(e))return T(sE,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return T(sE,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ti.enqueueRetryable(()=>this.fi(e)),this.isPrimary=e})}Fi(e){return tw(e,ek).get(eD).next(e=>ea.resolve(this.Ni(e)))}Bi(e){return tw(e,e2).delete(this.clientId)}async Li(){if(this.isPrimary&&!this.ki(this.mi,18e5)){this.mi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tw(e,e2);return t.G().next(e=>{let r=this.qi(e,18e5),n=e.filter(e=>-1===r.indexOf(e));return ea.forEach(n,e=>t.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.yi)for(let t of e)this.yi.removeItem(this.Qi(t.clientId))}}Di(){this.Vi=this.Ti.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.wi().then(()=>this.Li()).then(()=>this.Di()))}Ni(e){return!!e&&e.ownerId===this.clientId}Mi(e){return this.Ei?ea.resolve(!0):tw(e,ek).get(eD).next(t=>{if(null!==t&&this.ki(t.leaseTimestampMs,5e3)&&!this.$i(t.ownerId)){if(this.Ni(t)&&this.networkEnabled)return!0;if(!this.Ni(t)){if(!t.allowTabSynchronization)throw new N(S.FAILED_PRECONDITION,sb);return!1}}return!(!this.networkEnabled||!this.inForeground)||tw(e,e2).G().next(e=>void 0===this.qi(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,r=!this.inForeground&&e.inForeground,n=this.networkEnabled===e.networkEnabled;if(t||r&&n)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&T(sE,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.zr=!1,this.Ki(),this.Vi&&(this.Vi.cancel(),this.Vi=null),this.Ui(),this.Wi(),await this.pi.runTransaction("shutdown","readwrite",[ek,e2],e=>{let t=new ty(e,eT.ae);return this.xi(t).next(()=>this.Bi(t))}),this.pi.close(),this.Gi()}qi(e,t){return e.filter(e=>this.ki(e.updateTimeMs,t)&&!this.$i(e.clientId))}zi(){return this.runTransaction("getActiveClients","readonly",e=>tw(e,e2).G().next(e=>this.qi(e,18e5).map(e=>e.clientId)))}get started(){return this.zr}getGlobalsCache(){return this.jr}getMutationQueue(e,t){return iY.It(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new i$(e,this.serializer.Tt.databaseId)}getDocumentOverlayCache(e){return iE.It(this.serializer,e)}getBundleCache(){return this.Yr}runTransaction(e,t,r){var n;let i;T(sE,"Starting transaction:",e);let s=17===(n=this.di)?tp:16===n?tg:15===n?tg:14===n?tm:13===n?tm:12===n?tf:11===n?td:void x();return this.pi.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,n=>(i=new ty(n,this.Gr?this.Gr.next():eT.ae),"readwrite-primary"===t?this.Fi(i).next(e=>!!e||this.Mi(i)).next(t=>{if(!t)throw E(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)),new N(S.FAILED_PRECONDITION,en);return r(i)}).next(e=>this.Oi(i).next(()=>e)):this.ji(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}ji(e){return tw(e,ek).get(eD).next(e=>{if(null!==e&&this.ki(e.leaseTimestampMs,5e3)&&!this.$i(e.ownerId)&&!this.Ni(e)&&!(this.Ei||this.allowTabSynchronization&&e.allowTabSynchronization))throw new N(S.FAILED_PRECONDITION,sb)})}Oi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tw(e,ek).put(eD,t)}static D(){return eu.D()}xi(e){let t=tw(e,ek);return t.get(eD).next(e=>this.Ni(e)?(T(sE,"Releasing primary lease."),t.delete(eD)):ea.resolve())}ki(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(E(`Detected an update time that is in the future: ${e} > ${r}`),!1))}bi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ri=()=>{this.Ti.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.wi()))},this.document.addEventListener("visibilitychange",this.Ri),this.inForeground="visible"===this.document.visibilityState)}Ui(){this.Ri&&(this.document.removeEventListener("visibilitychange",this.Ri),this.Ri=null)}Si(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Ai=()=>{this.Ki();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ti.enterRestrictedMode(!0),this.Ti.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ai))}Wi(){this.Ai&&(this.window.removeEventListener("pagehide",this.Ai),this.Ai=null)}$i(e){var t;try{let r=null!==(null===(t=this.yi)||void 0===t?void 0:t.getItem(this.Qi(e)));return T(sE,`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(e){return E(sE,"Failed to get zombied client id.",e),!1}}Ki(){if(this.yi)try{this.yi.setItem(this.Qi(this.clientId),String(Date.now()))}catch(e){E("Failed to set zombie client id.",e)}}Gi(){if(this.yi)try{this.yi.removeItem(this.Qi(this.clientId))}catch(e){}}Qi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sx(e,t){let r=e.projectId;return e.isDefaultDatabase||(r+="."+e.database),"firestore/"+t+"/"+r+"/"}class sS{constructor(e,t,r,n){this.targetId=e,this.fromCache=t,this.Hi=r,this.Ji=n}static Yi(e,t){let r=r8(),n=r8();for(let e of t.docChanges)switch(e.type){case 0:r=r.add(e.doc.key);break;case 1:n=n.add(e.doc.key)}return new sS(e,t.fromCache,r,n)}}class sN{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class sk{constructor(){this.Zi=!1,this.Xi=!1,this.es=100,this.ts=(0,h.nr)()?8:eh((0,h.ZQ)())>0?6:4}initialize(e,t){this.ns=e,this.indexManager=t,this.Zi=!0}getDocumentsMatchingQuery(e,t,r,n){let i={result:null};return this.rs(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ss(e,t,n,r).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let r=new sN;return this._s(e,t,r).next(n=>{if(i.result=n,this.Xi)return this.us(e,t,r,n.size)})}).next(()=>i.result)}us(e,t,r,n){return r.documentReadCount<this.es?(I()<=u.$b.DEBUG&&T("QueryEngine","SDK will not create cache indexes for query:",rj(t),"since it only creates cache indexes for collection contains","more than or equal to",this.es,"documents"),ea.resolve()):(I()<=u.$b.DEBUG&&T("QueryEngine","Query:",rj(t),"scans",r.documentReadCount,"local documents and returns",n,"documents as results."),r.documentReadCount>this.ts*n?(I()<=u.$b.DEBUG&&T("QueryEngine","The SDK decides to create cache indexes for query:",rj(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,rB(t))):ea.resolve())}rs(e,t){if(rP(t))return ea.resolve(null);let r=rB(t);return this.indexManager.getIndexType(e,r).next(n=>0===n?null:(null!==t.limit&&1===n&&(r=rB(t=rz(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,r).next(n=>{let i=r8(...n);return this.ns.getDocuments(e,i).next(n=>this.indexManager.getMinOffset(e,r).next(r=>{let s=this.cs(t,n);return this.ls(t,s,i,r.readTime)?this.rs(e,rz(t,null,"F")):this.hs(e,s,t,r)}))})))}ss(e,t,r,n){return rP(t)||n.isEqual(B.min())?ea.resolve(null):this.ns.getDocuments(e,r).next(i=>{let s=this.cs(t,i);return this.ls(t,s,r,n)?ea.resolve(null):(I()<=u.$b.DEBUG&&T("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),rj(t)),this.hs(e,s,t,X(n,-1)).next(e=>e))})}cs(e,t){let r=new tx(rW(e));return t.forEach((t,n)=>{rQ(e,n)&&(r=r.add(n))}),r}ls(e,t,r,n){if(null===e.limit)return!1;if(r.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(n)>0)}_s(e,t,r){return I()<=u.$b.DEBUG&&T("QueryEngine","Using full collection scan to execute query:",rj(t)),this.ns.getDocumentsMatchingQuery(e,t,et.min(),r)}hs(e,t,r,n){return this.ns.getDocumentsMatchingQuery(e,r,n).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sD="LocalStore";class sC{constructor(e,t,r,n){this.persistence=e,this.Ps=t,this.serializer=n,this.Ts=new tE(P),this.Is=new rY(e=>rC(e),rA),this.Es=new Map,this.ds=e.getRemoteDocumentCache(),this.Hr=e.getTargetCache(),this.Yr=e.getBundleCache(),this.As(r)}As(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sa(this.ds,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ds.setIndexManager(this.indexManager),this.Ps.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ts))}}async function sA(e,t){return await e.persistence.runTransaction("Handle user change","readonly",r=>{let n;return e.mutationQueue.getAllMutationBatches(r).next(i=>(n=i,e.As(t),e.mutationQueue.getAllMutationBatches(r))).next(t=>{let i=[],s=[],a=r8();for(let e of n)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(r,a).next(e=>({Rs:e,removedBatchIds:i,addedBatchIds:s}))})})}function sV(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Hr.getLastRemoteSnapshotVersion(t))}function sR(e,t,r){let n=r8(),i=r8();return r.forEach(e=>n=n.add(e)),t.getEntries(e,n).next(e=>{let n=rZ;return r.forEach((r,s)=>{let a=e.get(r);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(r)),s.isNoDocument()&&s.version.isEqual(B.min())?(t.removeEntry(r,s.readTime),n=n.insert(r,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),n=n.insert(r,s)):T(sD,"Ignoring outdated watch update for ",r,". Current version:",a.version," Watch version:",s.version)}),{Vs:n,fs:i}})}function sO(e,t){return e.persistence.runTransaction("Allocate target","readwrite",r=>{let n;return e.Hr.getTargetData(r,t).next(i=>i?(n=i,ea.resolve(n)):e.Hr.allocateTargetId(r).next(i=>(n=new io(t,i,"TargetPurposeListen",r.currentSequenceNumber),e.Hr.addTargetData(r,n).next(()=>n))))}).then(r=>{let n=e.Ts.get(r.targetId);return(null===n||r.snapshotVersion.compareTo(n.snapshotVersion)>0)&&(e.Ts=e.Ts.insert(r.targetId,r),e.Is.set(t,r.targetId)),r})}async function sM(e,t,r){let n=e.Ts.get(t);try{r||await e.persistence.runTransaction("Release target",r?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,n))}catch(e){if(!ef(e))throw e;T(sD,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ts=e.Ts.remove(t),e.Is.delete(n.target)}function sL(e,t,r){let n=B.min(),i=r8();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,r){let n=e.Is.get(r);return void 0!==n?ea.resolve(e.Ts.get(n)):e.Hr.getTargetData(t,r)})(e,s,rB(t)).next(t=>{if(t)return n=t.lastLimboFreeSnapshotVersion,e.Hr.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Ps.getDocumentsMatchingQuery(s,t,r?n:B.min(),r?i:r8())).next(r=>(sU(e,rH(t),r),{documents:r,gs:i})))}function sF(e,t){let r=e.Hr,n=e.Ts.get(t);return n?Promise.resolve(n.target):e.persistence.runTransaction("Get target data","readonly",e=>r.lt(e,t).next(e=>e?e.target:null))}function sP(e,t){let r=e.Es.get(t)||B.min();return e.persistence.runTransaction("Get new document changes","readonly",n=>e.ds.getAllFromCollectionGroup(n,t,X(r,-1),Number.MAX_SAFE_INTEGER)).then(r=>(sU(e,t,r),r))}function sU(e,t,r){let n=e.Es.get(t)||B.min();r.forEach((e,t)=>{t.readTime.compareTo(n)>0&&(n=t.readTime)}),e.Es.set(t,n)}let sq="firestore_clients";function sB(e,t){return`${sq}_${e}_${t}`}let sK="firestore_mutations";function sz(e,t,r){let n=`${sK}_${e}_${r}`;return t.isAuthenticated()&&(n+=`_${t.uid}`),n}let s$="firestore_targets";function sG(e,t){return`${s$}_${e}_${t}`}let sj="SharedClientState";class sQ{constructor(e,t,r,n){this.user=e,this.batchId=t,this.state=r,this.error=n}static bs(e,t,r){let n=JSON.parse(r),i,s="object"==typeof n&&-1!==["pending","acknowledged","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(i=new N(n.error.code,n.error.message)),s?new sQ(e,t,n.state,i):(E(sj,`Failed to parse mutation state for ID '${t}': ${r}`),null)}Ss(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sH{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static bs(e,t){let r=JSON.parse(t),n,i="object"==typeof r&&-1!==["not-current","current","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(n=new N(r.error.code,r.error.message)),i?new sH(e,r.state,n):(E(sj,`Failed to parse target state for ID '${e}': ${t}`),null)}Ss(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sW{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static bs(e,t){let r=JSON.parse(t),n="object"==typeof r&&r.activeTargetIds instanceof Array,i=r4;for(let e=0;n&&e<r.activeTargetIds.length;++e)n=e_(r.activeTargetIds[e]),i=i.add(r.activeTargetIds[e]);return n?new sW(e,i):(E(sj,`Failed to parse client data for instance '${e}': ${t}`),null)}}class sY{constructor(e,t){this.clientId=e,this.onlineState=t}static bs(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new sY(t.clientId,t.onlineState):(E(sj,`Failed to parse online state: ${e}`),null)}}class sZ{constructor(){this.activeTargetIds=r4}Ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Ss(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class sJ{constructor(e,t,r,n,i){var s,a,o;this.window=e,this.Ti=t,this.persistenceKey=r,this.Cs=n,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Fs=this.Ms.bind(this),this.xs=new tE(P),this.started=!1,this.Os=[];let l=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ns=sB(this.persistenceKey,this.Cs),this.Bs=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.xs=this.xs.insert(this.Cs,new sZ),this.Ls=RegExp(`^${sq}_${l}_([^_]*)$`),this.ks=RegExp(`^${sK}_${l}_(\\d+)(?:_(.*))?$`),this.qs=RegExp(`^${s$}_${l}_(\\d+)$`),this.Qs=(a=this.persistenceKey,`firestore_online_state_${a}`),this.$s=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Fs)}static D(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.zi())){if(e===this.Cs)continue;let t=this.getItem(sB(this.persistenceKey,e));if(t){let r=sW.bs(e,t);r&&(this.xs=this.xs.insert(r.clientId,r))}}this.Ks();let e=this.storage.getItem(this.Qs);if(e){let t=this.Us(e);t&&this.Ws(t)}for(let e of this.Os)this.Ms(e);this.Os=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Gs(this.xs)}isActiveQueryTarget(e){let t=!1;return this.xs.forEach((r,n)=>{n.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.zs(e,"pending")}updateMutationState(e,t,r){this.zs(e,t,r),this.js(e)}addLocalQueryTarget(e,t=!0){let r="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(sG(this.persistenceKey,e));if(t){let n=sH.bs(e,t);n&&(r=n.state)}}return t&&this.Hs.Ds(e),this.Ks(),r}removeLocalQueryTarget(e){this.Hs.vs(e),this.Ks()}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(sG(this.persistenceKey,e))}updateQueryState(e,t,r){this.Js(e,t,r)}handleUserChange(e,t,r){t.forEach(e=>{this.js(e)}),this.currentUser=e,r.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ys(e)}notifyBundleLoaded(e){this.Zs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Fs),this.removeItem(this.Ns),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return T(sj,"READ",e,t),t}setItem(e,t){T(sj,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){T(sj,"REMOVE",e),this.storage.removeItem(e)}Ms(e){if(e.storageArea===this.storage){if(T(sj,"EVENT",e.key,e.newValue),e.key===this.Ns)return void E("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ti.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.Ls.test(e.key)){if(null==e.newValue){let t=this.Xs(e.key);return this.eo(t,null)}{let t=this.no(e.key,e.newValue);if(t)return this.eo(t.clientId,t)}}else if(this.ks.test(e.key)){if(null!==e.newValue){let t=this.ro(e.key,e.newValue);if(t)return this.io(t)}}else if(this.qs.test(e.key)){if(null!==e.newValue){let t=this.so(e.key,e.newValue);if(t)return this.oo(t)}}else if(e.key===this.Qs){if(null!==e.newValue){let t=this.Us(e.newValue);if(t)return this.Ws(t)}}else if(e.key===this.Bs){let t=function(e){let t=eT.ae;if(null!=e)try{let r=JSON.parse(e);"number"==typeof r||x(),t=r}catch(e){E(sj,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==eT.ae&&this.sequenceNumberHandler(t)}else if(e.key===this.$s){let t=this._o(e.newValue);await Promise.all(t.map(e=>this.syncEngine.ao(e)))}}}else this.Os.push(e)})}}get Hs(){return this.xs.get(this.Cs)}Ks(){this.setItem(this.Ns,this.Hs.Ss())}zs(e,t,r){let n=new sQ(this.currentUser,e,t,r),i=sz(this.persistenceKey,this.currentUser,e);this.setItem(i,n.Ss())}js(e){let t=sz(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ys(e){let t={clientId:this.Cs,onlineState:e};this.storage.setItem(this.Qs,JSON.stringify(t))}Js(e,t,r){let n=sG(this.persistenceKey,e),i=new sH(e,t,r);this.setItem(n,i.Ss())}Zs(e){let t=JSON.stringify(Array.from(e));this.setItem(this.$s,t)}Xs(e){let t=this.Ls.exec(e);return t?t[1]:null}no(e,t){let r=this.Xs(e);return sW.bs(r,t)}ro(e,t){let r=this.ks.exec(e),n=Number(r[1]),i=void 0!==r[2]?r[2]:null;return sQ.bs(new y(i),n,t)}so(e,t){let r=Number(this.qs.exec(e)[1]);return sH.bs(r,t)}Us(e){return sY.bs(e)}_o(e){return JSON.parse(e)}async io(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.uo(e.batchId,e.state,e.error);T(sj,`Ignoring mutation for non-active user ${e.user.uid}`)}oo(e){return this.syncEngine.co(e.targetId,e.state,e.error)}eo(e,t){let r=t?this.xs.insert(e,t):this.xs.remove(e),n=this.Gs(this.xs),i=this.Gs(r),s=[],a=[];return i.forEach(e=>{n.has(e)||s.push(e)}),n.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.lo(s,a).then(()=>{this.xs=r})}Ws(e){this.xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Gs(e){let t=r4;return e.forEach((e,r)=>{t=t.unionWith(r.activeTargetIds)}),t}}class sX{constructor(){this.ho=new sZ,this.Po={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e,t=!0){return t&&this.ho.Ds(e),this.Po[e]||"not-current"}updateQueryState(e,t,r){this.Po[e]=t}removeLocalQueryTarget(e){this.ho.vs(e)}isLocalQueryTarget(e){return this.ho.activeTargetIds.has(e)}clearQueryState(e){delete this.Po[e]}getAllActiveQueryTargets(){return this.ho.activeTargetIds}isActiveQueryTarget(e){return this.ho.activeTargetIds.has(e)}start(){return this.ho=new sZ,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class s0{To(e){}shutdown(){}}let s1="ConnectivityMonitor";class s2{constructor(){this.Io=()=>this.Eo(),this.Ao=()=>this.Ro(),this.Vo=[],this.mo()}To(e){this.Vo.push(e)}shutdown(){window.removeEventListener("online",this.Io),window.removeEventListener("offline",this.Ao)}mo(){window.addEventListener("online",this.Io),window.addEventListener("offline",this.Ao)}Eo(){for(let e of(T(s1,"Network connectivity changed: AVAILABLE"),this.Vo))e(0)}Ro(){for(let e of(T(s1,"Network connectivity changed: UNAVAILABLE"),this.Vo))e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let s5=null;function s8(){return null===s5?s5=0x10000000+Math.round(0x80000000*Math.random()):s5++,"0x"+s5.toString(16)}let s4="RestConnection",s3={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class s6{get fo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",r=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${r}/databases/${n}`,this.wo=this.databaseId.database===tz?`project_id=${r}`:`project_id=${r}&database_id=${n}`}bo(e,t,r,n,i){let s=s8(),a=this.So(e,t.toUriEncodedString());T(s4,`Sending RPC '${e}' ${s}:`,a,r);let o={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Do(o,n,i),this.vo(e,a,o,r).then(t=>(T(s4,`Received RPC '${e}' ${s}: `,t),t),t=>{throw b(s4,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",r),t})}Co(e,t,r,n,i,s){return this.bo(e,t,r,n,i)}Do(e,t,r){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,r)=>e[r]=t),r&&r.headers.forEach((t,r)=>e[r]=t)}So(e,t){let r=s3[e];return`${this.po}/v1/${t}:${r}`}terminate(){}}class s9{constructor(e){this.Fo=e.Fo,this.Mo=e.Mo}xo(e){this.Oo=e}No(e){this.Bo=e}Lo(e){this.ko=e}onMessage(e){this.qo=e}close(){this.Mo()}send(e){this.Fo(e)}Qo(){this.Oo()}$o(){this.Bo()}Ko(e){this.ko(e)}Uo(e){this.qo(e)}}let s7="WebChannelConnection";class ae extends s6{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(e,t,r,n){let i=s8();return new Promise((s,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();T(s7,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case d.O4.TIMEOUT:T(s7,`RPC '${e}' ${i} timed out`),a(new N(S.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let r=o.getStatus();if(T(s7,`RPC '${e}' ${i} failed with status:`,r,"response text:",o.getResponseText()),r>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(S).indexOf(t)>=0?t:S.UNKNOWN}(t.status);a(new N(e,t.message))}else a(new N(S.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new N(S.UNAVAILABLE,"Connection failed."));break;default:x()}}finally{T(s7,`RPC '${e}' ${i} completed.`)}});let l=JSON.stringify(n);T(s7,`RPC '${e}' ${i} sending request:`,n),o.send(t,"POST",l,r,15)})}Wo(e,t,r){let i=s8(),s=[this.po,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Do(l.initMessageHeaders,t,r),l.encodeInitMessageHeaders=!0;let h=s.join("");T(s7,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l),f=!1,m=!1,g=new s9({Fo:t=>{m?T(s7,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(T(s7,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),T(s7,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},Mo:()=>c.close()}),p=(e,t,r)=>{e.listen(t,e=>{try{r(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(T(s7,`RPC '${e}' stream ${i} transport opened.`),g.Qo())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,T(s7,`RPC '${e}' stream ${i} transport closed`),g.Ko())}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,b(s7,`RPC '${e}' stream ${i} transport errored:`,t),g.Ko(new N(S.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{var r;if(!m){let s=t.data[0];s||x();let a=(null==s?void 0:s.error)||(null===(r=s[0])||void 0===r?void 0:r.error);if(a){T(s7,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,r=function(e){let t=n[e];if(void 0!==t)return nk(t)}(t),s=a.message;void 0===r&&(r=S.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),m=!0,g.Ko(new N(r,s)),c.close()}else T(s7,`RPC '${e}' stream ${i} received:`,s),g.Uo(s)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?T(s7,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&T(s7,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.$o()},0),g}}function at(){return"undefined"!=typeof window?window:null}function ar(){return"undefined"!=typeof document?document:null}function an(e){return new nj(e,!0)}class ai{constructor(e,t,r=1e3,n=1.5,i=6e4){this.Ti=e,this.timerId=t,this.Go=r,this.zo=n,this.jo=i,this.Ho=0,this.Jo=null,this.Yo=Date.now(),this.reset()}reset(){this.Ho=0}Zo(){this.Ho=this.jo}Xo(e){this.cancel();let t=Math.floor(this.Ho+this.e_()),r=Math.max(0,Date.now()-this.Yo),n=Math.max(0,t-r);n>0&&T("ExponentialBackoff",`Backing off for ${n} ms (base delay: ${this.Ho} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.Jo=this.Ti.enqueueAfterDelay(this.timerId,n,()=>(this.Yo=Date.now(),e())),this.Ho*=this.zo,this.Ho<this.Go&&(this.Ho=this.Go),this.Ho>this.jo&&(this.Ho=this.jo)}t_(){null!==this.Jo&&(this.Jo.skipDelay(),this.Jo=null)}cancel(){null!==this.Jo&&(this.Jo.cancel(),this.Jo=null)}e_(){return(Math.random()-.5)*this.Ho}}let as="PersistentStream";class aa{constructor(e,t,r,n,i,s,a,o){this.Ti=e,this.n_=r,this.r_=n,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.i_=0,this.s_=null,this.o_=null,this.stream=null,this.__=0,this.a_=new ai(e,t)}u_(){return 1===this.state||5===this.state||this.c_()}c_(){return 2===this.state||3===this.state}start(){this.__=0,4!==this.state?this.auth():this.l_()}async stop(){this.u_()&&await this.close(0)}h_(){this.state=0,this.a_.reset()}P_(){this.c_()&&null===this.s_&&(this.s_=this.Ti.enqueueAfterDelay(this.n_,6e4,()=>this.T_()))}I_(e){this.E_(),this.stream.send(e)}async T_(){if(this.c_())return this.close(0)}E_(){this.s_&&(this.s_.cancel(),this.s_=null)}d_(){this.o_&&(this.o_.cancel(),this.o_=null)}async close(e,t){this.E_(),this.d_(),this.a_.cancel(),this.i_++,4!==e?this.a_.reset():t&&t.code===S.RESOURCE_EXHAUSTED?(E(t.toString()),E("Using maximum backoff delay to prevent overloading the backend."),this.a_.Zo()):t&&t.code===S.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.A_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Lo(t)}A_(){}auth(){this.state=1;let e=this.R_(this.i_),t=this.i_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,r])=>{this.i_===t&&this.V_(e,r)},t=>{e(()=>{let e=new N(S.UNKNOWN,"Fetching auth token failed: "+t.message);return this.m_(e)})})}V_(e,t){let r=this.R_(this.i_);this.stream=this.f_(e,t),this.stream.xo(()=>{r(()=>this.listener.xo())}),this.stream.No(()=>{r(()=>(this.state=2,this.o_=this.Ti.enqueueAfterDelay(this.r_,1e4,()=>(this.c_()&&(this.state=3),Promise.resolve())),this.listener.No()))}),this.stream.Lo(e=>{r(()=>this.m_(e))}),this.stream.onMessage(e=>{r(()=>1==++this.__?this.g_(e):this.onNext(e))})}l_(){this.state=5,this.a_.Xo(async()=>{this.state=0,this.start()})}m_(e){return T(as,`close with error: ${e}`),this.stream=null,this.close(4,e)}R_(e){return t=>{this.Ti.enqueueAndForget(()=>this.i_===e?t():(T(as,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class ao extends aa{constructor(e,t,r,n,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,n,s),this.serializer=i}f_(e,t){return this.connection.Wo("Listen",e,t)}g_(e){return this.onNext(e)}onNext(e){this.a_.reset();let t=function(e,t){let r;if("targetChange"in t){var n,i;t.targetChange;let s="NO_CHANGE"===(n=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===n?1:"REMOVE"===n?2:"CURRENT"===n?3:"RESET"===n?4:x(),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(void 0===i||"string"==typeof i||x(),tC.fromBase64String(i||"")):(void 0===i||i instanceof m||i instanceof Uint8Array||x(),tC.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;r=new nP(s,a,o,l&&new N(void 0===l.code?S.UNKNOWN:nk(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let n=t.documentChange;n.document,n.document.name,n.document.updateTime;let i=n1(e,n.document.name),s=nY(n.document.updateTime),a=n.document.createTime?nY(n.document.createTime):B.min(),o=new ra({mapValue:{fields:n.document.fields}}),l=ro.newFoundDocument(i,s,a,o);r=new nL(n.targetIds||[],n.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let n=t.documentDelete;n.document;let i=n1(e,n.document),s=n.readTime?nY(n.readTime):B.min(),a=ro.newNoDocument(i,s);r=new nL([],n.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let n=t.documentRemove;n.document;let i=n1(e,n.document);r=new nL([],n.removedTargetIds||[],i,null)}else{if(!("filter"in t))return x();{t.filter;let e=t.filter;e.targetId;let{count:n=0,unchangedNames:i}=e,s=new nN(n,i);r=new nF(e.targetId,s)}}return r}(this.serializer,e),r=function(e){if(!("targetChange"in e))return B.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?B.min():t.readTime?nY(t.readTime):B.min()}(e);return this.listener.p_(t,r)}y_(e){let t={};t.database=n8(this.serializer),t.addTarget=function(e,t){let r;let n=t.target;if((r=rV(n)?{documents:ie(e,n)}:{query:it(e,n).ht}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){r.resumeToken=nW(e,t.resumeToken);let n=nQ(e,t.expectedCount);null!==n&&(r.expectedCount=n)}else if(t.snapshotVersion.compareTo(B.min())>0){r.readTime=nH(e,t.snapshotVersion.toTimestamp());let n=nQ(e,t.expectedCount);null!==n&&(r.expectedCount=n)}return r}(this.serializer,e);let r=function(e,t){let r=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return x()}}(t.purpose);return null==r?null:{"goog-listen-tags":r}}(this.serializer,e);r&&(t.labels=r),this.I_(t)}w_(e){let t={};t.database=n8(this.serializer),t.removeTarget=e,this.I_(t)}}class al extends aa{constructor(e,t,r,n,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,n,s),this.serializer=i}get b_(){return this.__>0}start(){this.lastStreamToken=void 0,super.start()}A_(){this.b_&&this.S_([])}f_(e,t){return this.connection.Wo("Write",e,t)}g_(e){return e.streamToken||x(),this.lastStreamToken=e.streamToken,e.writeResults&&0!==e.writeResults.length&&x(),this.listener.D_()}onNext(e){var t,r;e.streamToken||x(),this.lastStreamToken=e.streamToken,this.a_.reset();let n=(t=e.writeResults,r=e.commitTime,t&&t.length>0?(void 0!==r||x(),t.map(e=>{let t;return(t=e.updateTime?nY(e.updateTime):nY(r)).isEqual(B.min())&&(t=nY(r)),new nh(t,e.transformResults||[])})):[]),i=nY(e.commitTime);return this.listener.v_(i,n)}C_(){let e={};e.database=n8(this.serializer),this.I_(e)}S_(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>n9(this.serializer,e))};this.I_(t)}}class au{}class ah extends au{constructor(e,t,r,n){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=n,this.F_=!1}M_(){if(this.F_)throw new N(S.FAILED_PRECONDITION,"The client has already been terminated.")}bo(e,t,r,n){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.bo(e,nJ(t,r),n,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(S.UNKNOWN,e.toString())})}Co(e,t,r,n,i){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Co(e,nJ(t,r),n,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(S.UNKNOWN,e.toString())})}terminate(){this.F_=!0,this.connection.terminate()}}class ac{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.x_=0,this.O_=null,this.N_=!0}B_(){0===this.x_&&(this.L_("Unknown"),this.O_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.O_=null,this.k_("Backend didn't respond within 10 seconds."),this.L_("Offline"),Promise.resolve())))}q_(e){"Online"===this.state?this.L_("Unknown"):(this.x_++,this.x_>=1&&(this.Q_(),this.k_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.L_("Offline")))}set(e){this.Q_(),this.x_=0,"Online"===e&&(this.N_=!1),this.L_(e)}L_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}k_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.N_?(E(t),this.N_=!1):T("OnlineStateTracker",t)}Q_(){null!==this.O_&&(this.O_.cancel(),this.O_=null)}}let ad="RemoteStore";class af{constructor(e,t,r,n,i){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.K_=[],this.U_=new Map,this.W_=new Set,this.G_=[],this.z_=i,this.z_.To(e=>{r.enqueueAndForget(async()=>{aE(this)&&(T(ad,"Restarting streams for network reachability change."),await async function(e){e.W_.add(4),await ag(e),e.j_.set("Unknown"),e.W_.delete(4),await am(e)}(this))})}),this.j_=new ac(r,n)}}async function am(e){if(aE(e))for(let t of e.G_)await t(!0)}async function ag(e){for(let t of e.G_)await t(!1)}function ap(e,t){e.U_.has(t.targetId)||(e.U_.set(t.targetId,t),aT(e)?aI(e):aP(e).c_()&&aw(e,t))}function ay(e,t){let r=aP(e);e.U_.delete(t),r.c_()&&av(e,t),0===e.U_.size&&(r.c_()?r.P_():aE(e)&&e.j_.set("Unknown"))}function aw(e,t){if(e.H_.Ne(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(B.min())>0){let r=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(r)}aP(e).y_(t)}function av(e,t){e.H_.Ne(t),aP(e).w_(t)}function aI(e){e.H_=new nq({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),lt:t=>e.U_.get(t)||null,it:()=>e.datastore.serializer.databaseId}),aP(e).start(),e.j_.B_()}function aT(e){return aE(e)&&!aP(e).u_()&&e.U_.size>0}function aE(e){return 0===e.W_.size}async function ab(e){e.j_.set("Online")}async function a_(e){e.U_.forEach((t,r)=>{aw(e,t)})}async function ax(e,t){e.H_=void 0,aT(e)?(e.j_.q_(t),aI(e)):e.j_.set("Unknown")}async function aS(e,t,r){if(e.j_.set("Online"),t instanceof nP&&2===t.state&&t.cause)try{await async function(e,t){let r=t.cause;for(let n of t.targetIds)e.U_.has(n)&&(await e.remoteSyncer.rejectListen(n,r),e.U_.delete(n),e.H_.removeTarget(n))}(e,t)}catch(r){T(ad,"Failed to remove targets %s: %s ",t.targetIds.join(","),r),await aN(e,r)}else if(t instanceof nL?e.H_.We(t):t instanceof nF?e.H_.Ze(t):e.H_.je(t),!r.isEqual(B.min()))try{let t=await sV(e.localStore);r.compareTo(t)>=0&&await function(e,t){let r=e.H_.ot(t);return r.targetChanges.forEach((r,n)=>{if(r.resumeToken.approximateByteSize()>0){let i=e.U_.get(n);i&&e.U_.set(n,i.withResumeToken(r.resumeToken,t))}}),r.targetMismatches.forEach((t,r)=>{let n=e.U_.get(t);if(!n)return;e.U_.set(t,n.withResumeToken(tC.EMPTY_BYTE_STRING,n.snapshotVersion)),av(e,t);let i=new io(n.target,t,r,n.sequenceNumber);aw(e,i)}),e.remoteSyncer.applyRemoteEvent(r)}(e,r)}catch(t){T(ad,"Failed to raise snapshot:",t),await aN(e,t)}}async function aN(e,t,r){if(!ef(t))throw t;e.W_.add(1),await ag(e),e.j_.set("Offline"),r||(r=()=>sV(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{T(ad,"Retrying IndexedDB access"),await r(),e.W_.delete(1),await am(e)})}function ak(e,t){return t().catch(r=>aN(e,r,t))}async function aD(e){let t=aU(e),r=e.K_.length>0?e.K_[e.K_.length-1].batchId:-1;for(;aE(e)&&e.K_.length<10;)try{let n=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",r=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(r,t)))}(e.localStore,r);if(null===n){0===e.K_.length&&t.P_();break}r=n.batchId,function(e,t){e.K_.push(t);let r=aU(e);r.c_()&&r.b_&&r.S_(t.mutations)}(e,n)}catch(t){await aN(e,t)}aC(e)&&aA(e)}function aC(e){return aE(e)&&!aU(e).u_()&&e.K_.length>0}function aA(e){aU(e).start()}async function aV(e){aU(e).C_()}async function aR(e){let t=aU(e);for(let r of e.K_)t.S_(r.mutations)}async function aO(e,t,r){let n=e.K_.shift(),i=nx.from(n,t,r);await ak(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aD(e)}async function aM(e,t){t&&aU(e).b_&&await async function(e,t){var r;if(function(e){switch(e){case S.OK:return x();case S.CANCELLED:case S.UNKNOWN:case S.DEADLINE_EXCEEDED:case S.RESOURCE_EXHAUSTED:case S.INTERNAL:case S.UNAVAILABLE:case S.UNAUTHENTICATED:return!1;case S.INVALID_ARGUMENT:case S.NOT_FOUND:case S.ALREADY_EXISTS:case S.PERMISSION_DENIED:case S.FAILED_PRECONDITION:case S.ABORTED:case S.OUT_OF_RANGE:case S.UNIMPLEMENTED:case S.DATA_LOSS:return!0;default:return x()}}(r=t.code)&&r!==S.ABORTED){let r=e.K_.shift();aU(e).h_(),await ak(e,()=>e.remoteSyncer.rejectFailedWrite(r.batchId,t)),await aD(e)}}(e,t),aC(e)&&aA(e)}async function aL(e,t){e.asyncQueue.verifyOperationInProgress(),T(ad,"RemoteStore received new credentials");let r=aE(e);e.W_.add(3),await ag(e),r&&e.j_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.W_.delete(3),await am(e)}async function aF(e,t){t?(e.W_.delete(2),await am(e)):t||(e.W_.add(2),await ag(e),e.j_.set("Unknown"))}function aP(e){var t,r,n;return e.J_||(e.J_=(t=e.datastore,r=e.asyncQueue,n={xo:ab.bind(null,e),No:a_.bind(null,e),Lo:ax.bind(null,e),p_:aS.bind(null,e)},t.M_(),new ao(r,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,n)),e.G_.push(async t=>{t?(e.J_.h_(),aT(e)?aI(e):e.j_.set("Unknown")):(await e.J_.stop(),e.H_=void 0)})),e.J_}function aU(e){var t,r,n;return e.Y_||(e.Y_=(t=e.datastore,r=e.asyncQueue,n={xo:()=>Promise.resolve(),No:aV.bind(null,e),Lo:aM.bind(null,e),D_:aR.bind(null,e),v_:aO.bind(null,e)},t.M_(),new al(r,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,n)),e.G_.push(async t=>{t?(e.Y_.h_(),await aD(e)):(await e.Y_.stop(),e.K_.length>0&&(T(ad,`Stopping write stream with ${e.K_.length} pending writes`),e.K_=[]))})),e.Y_}class aq{constructor(e,t,r,n,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=n,this.removalCallback=i,this.deferred=new k,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,n,i){let s=new aq(e,t,Date.now()+r,n,i);return s.start(r),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new N(S.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function aB(e,t){if(E("AsyncQueue",`${t}: ${e}`),ef(e))return new N(S.UNAVAILABLE,`${t}: ${e}`);throw e}class aK{static emptySet(e){return new aK(e.comparator)}constructor(e){this.comparator=e?(t,r)=>e(t,r)||Q.comparator(t.key,r.key):(e,t)=>Q.comparator(e.key,t.key),this.keyedMap=rX(),this.sortedSet=new tE(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof aK)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,n=r.getNext().key;if(!e.isEqual(n))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let r=new aK;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}}class az{constructor(){this.Z_=new tE(Q.comparator)}track(e){let t=e.doc.key,r=this.Z_.get(t);r?0!==e.type&&3===r.type?this.Z_=this.Z_.insert(t,e):3===e.type&&1!==r.type?this.Z_=this.Z_.insert(t,{type:r.type,doc:e.doc}):2===e.type&&2===r.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===r.type?this.Z_=this.Z_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===r.type?this.Z_=this.Z_.remove(t):1===e.type&&2===r.type?this.Z_=this.Z_.insert(t,{type:1,doc:r.doc}):0===e.type&&1===r.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):x():this.Z_=this.Z_.insert(t,e)}X_(){let e=[];return this.Z_.inorderTraversal((t,r)=>{e.push(r)}),e}}class a${constructor(e,t,r,n,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=n,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,r,n,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new a$(e,t,aK.emptySet(t),s,r,n,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&r$(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==r[e].type||!t[e].doc.isEqual(r[e].doc))return!1;return!0}}class aG{constructor(){this.ea=void 0,this.ta=[]}na(){return this.ta.some(e=>e.ra())}}class aj{constructor(){this.queries=aQ(),this.onlineState="Unknown",this.ia=new Set}terminate(){!function(e,t){let r=e.queries;e.queries=aQ(),r.forEach((e,r)=>{for(let e of r.ta)e.onError(t)})}(this,new N(S.ABORTED,"Firestore shutting down"))}}function aQ(){return new rY(e=>rG(e),r$)}function aH(e,t){let r=!1;for(let n of t){let t=n.query,i=e.queries.get(t);if(i){for(let e of i.ta)e.oa(n)&&(r=!0);i.ea=n}}r&&aY(e)}function aW(e,t,r){let n=e.queries.get(t);if(n)for(let e of n.ta)e.onError(r);e.queries.delete(t)}function aY(e){e.ia.forEach(e=>{e.next()})}(a=s||(s={}))._a="default",a.Cache="cache";class aZ{constructor(e){this.key=e}}class aJ{constructor(e){this.key=e}}class aX{constructor(e,t){this.query=e,this.fa=t,this.ga=null,this.hasCachedResults=!1,this.current=!1,this.pa=r8(),this.mutatedKeys=r8(),this.ya=rW(e),this.wa=new aK(this.ya)}get ba(){return this.fa}Sa(e,t){let r=t?t.Da:new az,n=t?t.wa:this.wa,i=t?t.mutatedKeys:this.mutatedKeys,s=n,a=!1,o="F"===this.query.limitType&&n.size===this.query.limit?n.last():null,l="L"===this.query.limitType&&n.size===this.query.limit?n.first():null;if(e.inorderTraversal((e,t)=>{let u=n.get(e),h=rQ(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(r.track({type:3,doc:h}),f=!0):this.va(u,h)||(r.track({type:2,doc:h}),f=!0,(o&&this.ya(h,o)>0||l&&0>this.ya(h,l))&&(a=!0)):!u&&h?(r.track({type:0,doc:h}),f=!0):u&&!h&&(r.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),r.track({type:1,doc:e})}return{wa:s,Da:r,ls:a,mutatedKeys:i}}va(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,n){let i=this.wa;this.wa=e.wa,this.mutatedKeys=e.mutatedKeys;let s=e.Da.X_();s.sort((e,t)=>(function(e,t){let r=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return x()}};return r(e)-r(t)})(e.type,t.type)||this.ya(e.doc,t.doc)),this.Ca(r),n=null!=n&&n;let a=t&&!n?this.Fa():[],o=0===this.pa.size&&this.current&&!n?1:0,l=o!==this.ga;return(this.ga=o,0!==s.length||l)?{snapshot:new a$(this.query,e.wa,i,s,e.mutatedKeys,0===o,l,!1,!!r&&r.resumeToken.approximateByteSize()>0),Ma:a}:{Ma:a}}sa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({wa:this.wa,Da:new az,mutatedKeys:this.mutatedKeys,ls:!1},!1)):{Ma:[]}}xa(e){return!this.fa.has(e)&&!!this.wa.has(e)&&!this.wa.get(e).hasLocalMutations}Ca(e){e&&(e.addedDocuments.forEach(e=>this.fa=this.fa.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.fa=this.fa.delete(e)),this.current=e.current)}Fa(){if(!this.current)return[];let e=this.pa;this.pa=r8(),this.wa.forEach(e=>{this.xa(e.key)&&(this.pa=this.pa.add(e.key))});let t=[];return e.forEach(e=>{this.pa.has(e)||t.push(new aJ(e))}),this.pa.forEach(r=>{e.has(r)||t.push(new aZ(r))}),t}Oa(e){this.fa=e.gs,this.pa=r8();let t=this.Sa(e.documents);return this.applyChanges(t,!0)}Na(){return a$.fromInitialDocuments(this.query,this.wa,this.mutatedKeys,0===this.ga,this.hasCachedResults)}}let a0="SyncEngine";class a1{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}}class a2{constructor(e){this.key=e,this.Ba=!1}}class a5{constructor(e,t,r,n,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=n,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.La={},this.ka=new rY(e=>rG(e),r$),this.qa=new Map,this.Qa=new Set,this.$a=new tE(Q.comparator),this.Ka=new Map,this.Ua=new sh,this.Wa={},this.Ga=new Map,this.za=iX.Un(),this.onlineState="Unknown",this.ja=void 0}get isPrimaryClient(){return!0===this.ja}}async function a8(e,t,r=!0){let n;let i=ob(e),s=i.ka.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),n=s.view.Na()):n=await a3(i,t,r,!0),n}async function a4(e,t){let r=ob(e);await a3(r,t,!0,!1)}async function a3(e,t,r,n){let i;let s=await sO(e.localStore,rB(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,r);return n&&(i=await a6(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&r&&ap(e.remoteStore,s),i}async function a6(e,t,r,n,i){e.Ha=(t,r,n)=>(async function(e,t,r,n){let i=t.view.Sa(r);i.ls&&(i=await sL(e.localStore,t.query,!1).then(({documents:e})=>t.view.Sa(e,i)));let s=n&&n.targetChanges.get(t.targetId),a=n&&null!=n.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return ou(e,t.targetId,o.Ma),o.snapshot})(e,t,r,n);let s=await sL(e.localStore,t,!0),a=new aX(t,s.gs),o=a.Sa(s.documents),l=nM.createSynthesizedTargetChangeForCurrentChange(r,n&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);ou(e,r,u.Ma);let h=new a1(t,r,a);return e.ka.set(t,h),e.qa.has(r)?e.qa.get(r).push(t):e.qa.set(r,[t]),u.snapshot}async function a9(e,t,r){let n=e.ka.get(t),i=e.qa.get(n.targetId);if(i.length>1)return e.qa.set(n.targetId,i.filter(e=>!r$(e,t))),void e.ka.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(n.targetId),e.sharedClientState.isActiveQueryTarget(n.targetId)||await sM(e.localStore,n.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(n.targetId),r&&ay(e.remoteStore,n.targetId),oo(e,n.targetId)}).catch(es)):(oo(e,n.targetId),await sM(e.localStore,n.targetId,!0))}async function a7(e,t){let r=e.ka.get(t),n=e.qa.get(r.targetId);e.isPrimaryClient&&1===n.length&&(e.sharedClientState.removeLocalQueryTarget(r.targetId),ay(e.remoteStore,r.targetId))}async function oe(e,t){try{let r=await function(e,t){let r=t.snapshotVersion,n=e.Ts;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.ds.newChangeBuffer({trackRemovals:!0});n=e.Ts;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=n.get(o);if(!u)return;a.push(e.Hr.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Hr.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tC.EMPTY_BYTE_STRING,B.min()).withLastLimboFreeSnapshotVersion(B.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,r)),n=n.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Hr.updateTargetData(i,h))});let o=rZ,l=r8();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,r))}),a.push(sR(i,s,t.documentUpdates).next(e=>{o=e.Vs,l=e.fs})),!r.isEqual(B.min())){let t=e.Hr.getLastRemoteSnapshotVersion(i).next(t=>e.Hr.setTargetsMetadata(i,i.currentSequenceNumber,r));a.push(t)}return ea.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ts=n,t))}(e.localStore,t);t.targetChanges.forEach((t,r)=>{let n=e.Ka.get(r);n&&(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1||x(),t.addedDocuments.size>0?n.Ba=!0:t.modifiedDocuments.size>0?n.Ba||x():t.removedDocuments.size>0&&(n.Ba||x(),n.Ba=!1))}),await oc(e,r,t)}catch(e){await es(e)}}function ot(e,t,r){var n;if(e.isPrimaryClient&&0===r||!e.isPrimaryClient&&1===r){let r;let i=[];e.ka.forEach((e,r)=>{let n=r.view.sa(t);n.snapshot&&i.push(n.snapshot)}),(n=e.eventManager).onlineState=t,r=!1,n.queries.forEach((e,n)=>{for(let e of n.ta)e.sa(t)&&(r=!0)}),r&&aY(n),i.length&&e.La.p_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function or(e,t,r){e.sharedClientState.updateQueryState(t,"rejected",r);let n=e.Ka.get(t),i=n&&n.key;if(i){let r=new tE(Q.comparator);r=r.insert(i,ro.newNoDocument(i,B.min()));let n=r8().add(i),s=new nO(B.min(),new Map,new tE(P),r,n);await oe(e,s),e.$a=e.$a.remove(i),e.Ka.delete(t),oh(e)}else await sM(e.localStore,t,!1).then(()=>oo(e,t,r)).catch(es)}async function on(e,t){var r;let n=t.batch.batchId;try{let i=await (r=e.localStore).persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let n=t.batch.keys(),i=r.ds.newChangeBuffer({trackRemovals:!0});return(function(e,t,r,n){let i=r.batch,s=i.keys(),a=ea.resolve();return s.forEach(e=>{a=a.next(()=>n.getEntry(t,e)).next(t=>{let s=r.docVersions.get(e);null!==s||x(),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,r),t.isValidDocument()&&(t.setReadTime(r.commitVersion),n.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(r,e,t,i).next(()=>i.apply(e)).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t.batch.batchId)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=r8();for(let r=0;r<e.mutationResults.length;++r)e.mutationResults[r].transformResults.length>0&&(t=t.add(e.batch.mutations[r].key));return t}(t))).next(()=>r.localDocuments.getDocuments(e,n))});oa(e,n,null),os(e,n),e.sharedClientState.updateMutationState(n,"acknowledged"),await oc(e,i)}catch(e){await es(e)}}async function oi(e,t,r){var n;try{let i=await (n=e.localStore).persistence.runTransaction("Reject batch","readwrite-primary",e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next(t=>(null!==t||x(),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t))).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)).next(()=>n.localDocuments.getDocuments(e,r))});oa(e,t,r),os(e,t),e.sharedClientState.updateMutationState(t,"rejected",r),await oc(e,i)}catch(e){await es(e)}}function os(e,t){(e.Ga.get(t)||[]).forEach(e=>{e.resolve()}),e.Ga.delete(t)}function oa(e,t,r){let n=e.Wa[e.currentUser.toKey()];if(n){let i=n.get(t);i&&(r?i.reject(r):i.resolve(),n=n.remove(t)),e.Wa[e.currentUser.toKey()]=n}}function oo(e,t,r=null){for(let n of(e.sharedClientState.removeLocalQueryTarget(t),e.qa.get(t)))e.ka.delete(n),r&&e.La.Ja(n,r);e.qa.delete(t),e.isPrimaryClient&&e.Ua.Sr(t).forEach(t=>{e.Ua.containsKey(t)||ol(e,t)})}function ol(e,t){e.Qa.delete(t.path.canonicalString());let r=e.$a.get(t);null!==r&&(ay(e.remoteStore,r),e.$a=e.$a.remove(t),e.Ka.delete(r),oh(e))}function ou(e,t,r){for(let n of r)n instanceof aZ?(e.Ua.addReference(n.key,t),function(e,t){let r=t.key,n=r.path.canonicalString();e.$a.get(r)||e.Qa.has(n)||(T(a0,"New document in limbo: "+r),e.Qa.add(n),oh(e))}(e,n)):n instanceof aJ?(T(a0,"Document no longer in limbo: "+n.key),e.Ua.removeReference(n.key,t),e.Ua.containsKey(n.key)||ol(e,n.key)):x()}function oh(e){for(;e.Qa.size>0&&e.$a.size<e.maxConcurrentLimboResolutions;){let t=e.Qa.values().next().value;e.Qa.delete(t);let r=new Q($.fromString(t)),n=e.za.next();e.Ka.set(n,new a2(r)),e.$a=e.$a.insert(r,n),ap(e.remoteStore,new io(rB(rF(r.path)),n,"TargetPurposeLimboResolution",eT.ae))}}async function oc(e,t,r){let n=[],i=[],s=[];e.ka.isEmpty()||(e.ka.forEach((a,o)=>{s.push(e.Ha(o,t,r).then(t=>{var s;if((t||r)&&e.isPrimaryClient){let n=t?!t.fromCache:null===(s=null==r?void 0:r.targetChanges.get(o.targetId))||void 0===s?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,n?"current":"not-current")}if(t){n.push(t);let e=sS.Yi(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.La.p_(n),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",r=>ea.forEach(t,t=>ea.forEach(t.Hi,n=>e.persistence.referenceDelegate.addReference(r,t.targetId,n)).next(()=>ea.forEach(t.Ji,n=>e.persistence.referenceDelegate.removeReference(r,t.targetId,n)))))}catch(e){if(!ef(e))throw e;T(sD,"Failed to update sequence numbers: "+e)}for(let r of t){let t=r.targetId;if(!r.fromCache){let r=e.Ts.get(t),n=r.snapshotVersion,i=r.withLastLimboFreeSnapshotVersion(n);e.Ts=e.Ts.insert(t,i)}}}(e.localStore,i))}async function od(e,t){var r;if(!e.currentUser.isEqual(t)){T(a0,"User change. New user:",t.toKey());let n=await sA(e.localStore,t);e.currentUser=t,r="'waitForPendingWrites' promise is rejected due to a user change.",e.Ga.forEach(e=>{e.forEach(e=>{e.reject(new N(S.CANCELLED,r))})}),e.Ga.clear(),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await oc(e,n.Rs)}}function of(e,t){let r=e.Ka.get(t);if(r&&r.Ba)return r8().add(r.key);{let r=r8(),n=e.qa.get(t);if(!n)return r;for(let t of n){let n=e.ka.get(t);r=r.unionWith(n.view.ba)}return r}}async function om(e,t){let r=await sL(e.localStore,t.query,!0),n=t.view.Oa(r);return e.isPrimaryClient&&ou(e,t.targetId,n.Ma),n}async function og(e,t){return sP(e.localStore,t).then(t=>oc(e,t))}async function op(e,t,r,n){let i=await function(e,t){let r=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",n=>r.Ln(n,t).next(t=>t?e.localDocuments.getDocuments(n,t):ea.resolve(null)))}(e.localStore,t);null!==i?("pending"===r?await aD(e.remoteStore):"acknowledged"===r||"rejected"===r?(oa(e,t,n||null),os(e,t),function(e,t){e.mutationQueue.qn(t)}(e.localStore,t)):x(),await oc(e,i)):T(a0,"Cannot apply mutation batch with id: "+t)}async function oy(e,t){if(ob(e),o_(e),!0===t&&!0!==e.ja){let t=e.sharedClientState.getAllActiveQueryTargets(),r=await ow(e,t.toArray());for(let t of(e.ja=!0,await aF(e.remoteStore,!0),r))ap(e.remoteStore,t)}else if(!1===t&&!1!==e.ja){let t=[],r=Promise.resolve();e.qa.forEach((n,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):r=r.then(()=>(oo(e,i),sM(e.localStore,i,!0))),ay(e.remoteStore,i)}),await r,await ow(e,t),e.Ka.forEach((t,r)=>{ay(e.remoteStore,r)}),e.Ua.Dr(),e.Ka=new Map,e.$a=new tE(Q.comparator),e.ja=!1,await aF(e.remoteStore,!1)}}async function ow(e,t,r){let n=[],i=[];for(let r of t){let t;let s=e.qa.get(r);if(s&&0!==s.length)for(let r of(t=await sO(e.localStore,rB(s[0])),s)){let t=e.ka.get(r),n=await om(e,t);n.snapshot&&i.push(n.snapshot)}else{let n=await sF(e.localStore,r);t=await sO(e.localStore,n),await a6(e,ov(n),r,!1,t.resumeToken)}n.push(t)}return e.La.p_(i),n}function ov(e){var t,r,n,i;return t=e.path,r=e.collectionGroup,n=e.orderBy,i=e.filters,new rL(t,r,n,i,e.limit,"F",e.startAt,e.endAt)}function oI(e){return e.localStore.persistence.zi()}async function oT(e,t,r,n){if(e.ja)return void T(a0,"Ignoring unexpected query state notification.");let i=e.qa.get(t);if(i&&i.length>0)switch(r){case"current":case"not-current":{let n=await sP(e.localStore,rH(i[0])),s=nO.createSynthesizedRemoteEventForCurrentChange(t,"current"===r,tC.EMPTY_BYTE_STRING);await oc(e,n,s);break}case"rejected":await sM(e.localStore,t,!0),oo(e,t,n);break;default:x()}}async function oE(e,t,r){let n=ob(e);if(n.ja){for(let e of t){if(n.qa.has(e)&&n.sharedClientState.isActiveQueryTarget(e)){T(a0,"Adding an already active target "+e);continue}let t=await sF(n.localStore,e),r=await sO(n.localStore,t);await a6(n,ov(t),r.targetId,!1,r.resumeToken),ap(n.remoteStore,r)}for(let e of r)n.qa.has(e)&&await sM(n.localStore,e,!1).then(()=>{ay(n.remoteStore,e),oo(n,e)}).catch(es)}}function ob(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=oe.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=of.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=or.bind(null,e),e.La.p_=aH.bind(null,e.eventManager),e.La.Ja=aW.bind(null,e.eventManager),e}function o_(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=on.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=oi.bind(null,e),e}class ox{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=an(e.databaseInfo.databaseId),this.sharedClientState=this.Za(e),this.persistence=this.Xa(e),await this.persistence.start(),this.localStore=this.eu(e),this.gcScheduler=this.tu(e,this.localStore),this.indexBackfillerScheduler=this.nu(e,this.localStore)}tu(e,t){return null}nu(e,t){return null}eu(e){var t;return t=this.persistence,new sC(t,new sk,e.initialUser,this.serializer)}Xa(e){return new sp(sw.ri,this.serializer)}Za(e){return new sX}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}ox.provider={build:()=>new ox};class oS extends ox{constructor(e){super(),this.cacheSizeBytes=e}tu(e,t){return this.persistence.referenceDelegate instanceof sv||x(),new i4(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Xa(e){let t=void 0!==this.cacheSizeBytes?iQ.withCacheSize(this.cacheSizeBytes):iQ.DEFAULT;return new sp(e=>sv.ri(e,t),this.serializer)}}class oN extends ox{constructor(e,t,r){super(),this.ru=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.ru.initialize(this,e),await o_(this.ru.syncEngine),await aD(this.ru.remoteStore),await this.persistence.Ci(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}eu(e){var t;return t=this.persistence,new sC(t,new sk,e.initialUser,this.serializer)}tu(e,t){return new i4(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}nu(e,t){let r=new eI(t,this.persistence);return new ev(e.asyncQueue,r)}Xa(e){let t=sx(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=void 0!==this.cacheSizeBytes?iQ.withCacheSize(this.cacheSizeBytes):iQ.DEFAULT;return new s_(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,at(),ar(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Za(e){return new sX}}class ok{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>ot(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=od.bind(null,this.syncEngine),await aF(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new aj}createDatastore(e){let t=an(e.databaseInfo.databaseId),r=new ae(e.databaseInfo);return new ah(e.authCredentials,e.appCheckCredentials,r,t)}createRemoteStore(e){var t;return t=this.localStore,new af(t,this.datastore,e.asyncQueue,e=>ot(this.syncEngine,e,0),s2.D()?new s2:new s0)}createSyncEngine(e,t){return function(e,t,r,n,i,s,a){let o=new a5(e,t,r,n,i,s);return a&&(o.ja=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){T(ad,"RemoteStore shutting down."),e.W_.add(5),await ag(e),e.z_.shutdown(),e.j_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate(),null===(t=this.eventManager)||void 0===t||t.terminate()}}ok.provider={build:()=>new ok};let oD="FirestoreClient";class oC{constructor(e,t,r,n,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=n,this.user=y.UNAUTHENTICATED,this.clientId=F.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(r,async e=>{T(oD,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(r,e=>(T(oD,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new k;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(r){let t=aB(r,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function oA(e,t){e.asyncQueue.verifyOperationInProgress(),T(oD,"Initializing OfflineComponentProvider");let r=e.configuration;await t.initialize(r);let n=r.initialUser;e.setCredentialChangeListener(async e=>{n.isEqual(e)||(await sA(t.localStore,e),n=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function oV(e,t){e.asyncQueue.verifyOperationInProgress();let r=await oR(e);T(oD,"Initializing OnlineComponentProvider"),await t.initialize(r,e.configuration),e.setCredentialChangeListener(e=>aL(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,r)=>aL(t.remoteStore,r)),e._onlineComponents=t}async function oR(e){if(!e._offlineComponents){if(e._uninitializedComponentsProvider){T(oD,"Using user provided OfflineComponentProvider");try{await oA(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===S.FAILED_PRECONDITION||t.code===S.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;b("Error using user provided cache. Falling back to memory cache: "+t),await oA(e,new ox)}}else T(oD,"Using default OfflineComponentProvider"),await oA(e,new oS(void 0))}return e._offlineComponents}async function oO(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(T(oD,"Using user provided OnlineComponentProvider"),await oV(e,e._uninitializedComponentsProvider._online)):(T(oD,"Using default OnlineComponentProvider"),await oV(e,new ok))),e._onlineComponents}function oM(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let oL=new Map;function oF(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let r=(t=e).constructor?t.constructor.name:null;return r?`a custom ${r} object`:"an object"}}return"function"==typeof e?"a function":x()}let oP="firestore.googleapis.com";class oU{constructor(e){var t,r;if(void 0===e.host){if(void 0!==e.ssl)throw new N(S.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=oP,this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new N(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,r,n){if(!0===t&&!0===n)throw new N(S.INVALID_ARGUMENT,`${e} and ${r} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=oM(null!==(r=e.experimentalLongPollingOptions)&&void 0!==r?r:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new N(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,r;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,r=e.experimentalLongPollingOptions,t.timeoutSeconds===r.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class oq{constructor(e,t,r,n){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new oU({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new N(S.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new N(S.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new oU(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new C;switch(e.type){case"firstParty":return new O(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new N(S.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=oL.get(e);t&&(T("ComponentProvider","Removing Datastore"),oL.delete(e),t.terminate())}(this),Promise.resolve()}}class oB{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new oB(this.firestore,e,this._query)}}class oK{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new oz(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new oK(this.firestore,e,this._key)}}class oz extends oB{constructor(e,t,r){super(e,t,rF(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new oK(this.firestore,null,new Q(e))}withConverter(e){return new oz(this.firestore,e,this._path)}}let o$="AsyncQueue";class oG{constructor(e=Promise.resolve()){this.Vu=[],this.mu=!1,this.fu=[],this.gu=null,this.pu=!1,this.yu=!1,this.wu=[],this.a_=new ai(this,"async_queue_retry"),this.bu=()=>{let e=ar();e&&T(o$,"Visibility state changed to "+e.visibilityState),this.a_.t_()},this.Su=e;let t=ar();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.bu)}get isShuttingDown(){return this.mu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Du(),this.vu(e)}enterRestrictedMode(e){if(!this.mu){this.mu=!0,this.yu=e||!1;let t=ar();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.bu)}}enqueue(e){if(this.Du(),this.mu)return new Promise(()=>{});let t=new k;return this.vu(()=>this.mu&&this.yu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Vu.push(e),this.Cu()))}async Cu(){if(0!==this.Vu.length){try{await this.Vu[0](),this.Vu.shift(),this.a_.reset()}catch(e){if(!ef(e))throw e;T(o$,"Operation failed with retryable error: "+e)}this.Vu.length>0&&this.a_.Xo(()=>this.Cu())}}vu(e){let t=this.Su.then(()=>(this.pu=!0,e().catch(e=>{let t;throw this.gu=e,this.pu=!1,E("INTERNAL UNHANDLED ERROR: ",(t=e.message||"",e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t)),e}).then(e=>(this.pu=!1,e))));return this.Su=t,t}enqueueAfterDelay(e,t,r){this.Du(),this.wu.indexOf(e)>-1&&(t=0);let n=aq.createAndSchedule(this,e,t,r,e=>this.Fu(e));return this.fu.push(n),n}Du(){this.gu&&x()}verifyOperationInProgress(){}async Mu(){let e;do e=this.Su,await e;while(e!==this.Su)}xu(e){for(let t of this.fu)if(t.timerId===e)return!0;return!1}Ou(e){return this.Mu().then(()=>{for(let t of(this.fu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.fu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Mu()})}Nu(e){this.wu.push(e)}Fu(e){let t=this.fu.indexOf(e);this.fu.splice(t,1)}}class oj extends oq{constructor(e,t,r,n){super(e,t,r,n),this.type="firestore",this._queue=new oG,this._persistenceKey=(null==n?void 0:n.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new oG(e),this._firestoreClient=void 0,await e}}}function oQ(e,t){let r="object"==typeof e?e:(0,o.Sx)(),n=(0,o.j6)(r,"firestore").getImmediate({identifier:"string"==typeof e?e:t||tz});if(!n._initialized){let e=(0,h.yU)("firestore");e&&function(e,t,r,n={}){var i;let s=(e=function(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new N(S.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let r=oF(e);throw new N(S.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${r}`)}}return e}(e,oq))._getSettings(),a=Object.assign(Object.assign({},s),{emulatorOptions:e._getEmulatorOptions()}),o=`${t}:${r}`;s.host!==oP&&s.host!==o&&b("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l=Object.assign(Object.assign({},s),{host:o,ssl:!1,emulatorOptions:n});if(!(0,h.bD)(l,a)&&(e._setSettings(l),n.mockUserToken)){let t,r;if("string"==typeof n.mockUserToken)t=n.mockUserToken,r=y.MOCK_USER;else{t=(0,h.Fy)(n.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);let s=n.mockUserToken.sub||n.mockUserToken.user_id;if(!s)throw new N(S.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");r=new y(s)}e._authCredentials=new A(new D(t,r))}}(n,...e)}return n}class oH{constructor(e){this._byteString=e}static fromBase64String(e){try{return new oH(tC.fromBase64String(e))}catch(e){throw new N(S.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new oH(tC.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class oW{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new N(S.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new j(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class oY{constructor(e){this._methodName=e}}class oZ{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new N(S.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new N(S.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return P(this._lat,e._lat)||P(this._long,e._long)}}class oJ{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}(this._values,e._values)}}let oX=/^__.*__$/;class o0{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return null!==this.fieldMask?new nw(e,this.data,this.fieldMask,t,this.fieldTransforms):new ny(e,this.data,t,this.fieldTransforms)}}class o1{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new nw(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function o2(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw x()}}class o5{constructor(e,t,r,n,i,s){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=n,void 0===i&&this.Bu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Lu(){return this.settings.Lu}ku(e){return new o5(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}qu(e){var t;let r=null===(t=this.path)||void 0===t?void 0:t.child(e),n=this.ku({path:r,Qu:!1});return n.$u(e),n}Ku(e){var t;let r=null===(t=this.path)||void 0===t?void 0:t.child(e),n=this.ku({path:r,Qu:!1});return n.Bu(),n}Uu(e){return this.ku({path:void 0,Qu:!0})}Wu(e){return lh(e,this.settings.methodName,this.settings.Gu||!1,this.path,this.settings.zu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Bu(){if(this.path)for(let e=0;e<this.path.length;e++)this.$u(this.path.get(e))}$u(e){if(0===e.length)throw this.Wu("Document fields must not be empty");if(o2(this.Lu)&&oX.test(e))throw this.Wu('Document fields cannot begin and end with "__"')}}class o8{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||an(e)}ju(e,t,r,n=!1){return new o5({Lu:e,methodName:t,zu:r,path:j.emptyPath(),Qu:!1,Gu:n},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function o4(e){let t=e._freezeSettings(),r=an(e._databaseId);return new o8(e._databaseId,!!t.ignoreUndefinedProperties,r)}class o3 extends oY{_toFieldTransform(e){if(2!==e.Lu)throw 1===e.Lu?e.Wu(`${this._methodName}() can only appear at the top level of your update data`):e.Wu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof o3}}function o6(e,t,r){return new o5({Lu:3,zu:t.settings.zu,methodName:e._methodName,Qu:r},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class o9 extends null{_toFieldTransform(e){return new nu(e.path,new nt)}isEqual(e){return e instanceof o9}}class o7 extends oY{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=o6(this,e,!0),r=new nr(this.Hu.map(e=>ln(e,t)));return new nu(e.path,r)}isEqual(e){return e instanceof o7&&(0,h.bD)(this.Hu,e.Hu)}}class le extends oY{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=o6(this,e,!0),r=new ni(this.Hu.map(e=>ln(e,t)));return new nu(e.path,r)}isEqual(e){return e instanceof le&&(0,h.bD)(this.Hu,e.Hu)}}class lt extends oY{constructor(e,t){super(e),this.Ju=t}_toFieldTransform(e){let t=new na(e.serializer,r9(e.serializer,this.Ju));return new nu(e.path,t)}isEqual(e){return e instanceof lt&&this.Ju===e.Ju}}function lr(e,t,r,n=!1){return ln(r,e.ju(n?4:3,t))}function ln(e,t){if(ls(e=(0,h.Ku)(e)))return la("Unsupported field value:",t,e),li(e,t);if(e instanceof oY)return function(e,t){if(!o2(t.Lu))throw t.Wu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Wu(`${e._methodName}() is not currently supported inside arrays`);let r=e._toFieldTransform(t);r&&t.fieldTransforms.push(r)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Qu&&4!==t.Lu)throw t.Wu("Nested arrays are not supported");return function(e,t){let r=[],n=0;for(let i of e){let e=ln(i,t.Uu(n));null==e&&(e={nullValue:"NULL_VALUE"}),r.push(e),n++}return{arrayValue:{values:r}}}(e,t)}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return r9(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let r=q.fromDate(e);return{timestampValue:nH(t.serializer,r)}}if(e instanceof q){let r=new q(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:nH(t.serializer,r)}}if(e instanceof oZ)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof oH)return{bytesValue:nW(t.serializer,e._byteString)};if(e instanceof oK){let r=t.databaseId,n=e.firestore._databaseId;if(!n.isEqual(r))throw t.Wu(`Document reference is for database ${n.projectId}/${n.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:nZ(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof oJ)return{mapValue:{fields:{[tG]:{stringValue:tH},[tW]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Wu("VectorValues must only contain numeric values.");return r3(t.serializer,e)})}}}}};throw t.Wu(`Unsupported field value: ${oF(e)}`)}(e,t)}function li(e,t){let r={};return tT(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tI(e,(e,n)=>{let i=ln(n,t.qu(e));null!=i&&(r[e]=i)}),{mapValue:{fields:r}}}function ls(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof q||e instanceof oZ||e instanceof oH||e instanceof oK||e instanceof oY||e instanceof oJ)}function la(e,t,r){if(!ls(r)||!("object"==typeof r&&null!==r&&(Object.getPrototypeOf(r)===Object.prototype||null===Object.getPrototypeOf(r)))){let n=oF(r);throw"an object"===n?t.Wu(e+" a custom object"):t.Wu(e+" "+n)}}function lo(e,t,r){if((t=(0,h.Ku)(t))instanceof oW)return t._internalPath;if("string"==typeof t)return lu(e,t);throw lh("Field path arguments must be of type string or ",e,!1,void 0,r)}let ll=RegExp("[~\\*/\\[\\]]");function lu(e,t,r){if(t.search(ll)>=0)throw lh(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,r);try{return new oW(...t.split("."))._internalPath}catch(n){throw lh(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,r)}}function lh(e,t,r,n,i){let s=n&&!n.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;r&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${n}`),a&&(l+=` in document ${i}`),l+=")"),new N(S.INVALID_ARGUMENT,o+e+l)}function lc(e,t){return e.some(e=>e.isEqual(t))}class ld{constructor(e,t,r,n,i){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=n,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new oK(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new lf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(lm("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class lf extends ld{data(){return super.data()}}function lm(e,t){return"string"==typeof t?lu(e,t):t instanceof oW?t._internalPath:t._delegate._internalPath}class lg{}class lp extends lg{}class ly extends lp{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new ly(e,t,r)}_apply(e){let t=this._parse(e);return lS(e._query,t),new oB(e.firestore,e.converter,rK(e._query,t))}_parse(e){let t=o4(e.firestore);return function(e,t,r,n,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new N(S.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){lx(a,s);let t=[];for(let r of a)t.push(l_(n,e,r));o={arrayValue:{values:t}}}else o=l_(n,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||lx(a,s),o=lr(r,t,a,"in"===s||"not-in"===s);return rf.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class lw extends lg{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new lw(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:rm.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let r=e;for(let e of t.getFlattenedFilters())lS(r,e),r=rK(r,e)}(e._query,t),new oB(e.firestore,e.converter,rK(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class lv extends lp{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new lv(e,t)}_apply(e){let t=function(e,t,r){if(null!==e.startAt)throw new N(S.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new N(S.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new rc(t,r)}(e._query,this._field,this._direction);return new oB(e.firestore,e.converter,function(e,t){let r=e.explicitOrderBy.concat([t]);return new rL(e.path,e.collectionGroup,r,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class lI extends lp{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new lI(e,t,r)}_apply(e){return new oB(e.firestore,e.converter,rz(e._query,this._limit,this._limitType))}}class lT extends lp{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new lT(e,t,r)}_apply(e){var t;let r=lb(e,this.type,this._docOrFields,this._inclusive);return new oB(e.firestore,e.converter,new rL((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,r,t.endAt))}}class lE extends lp{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new lE(e,t,r)}_apply(e){var t;let r=lb(e,this.type,this._docOrFields,this._inclusive);return new oB(e.firestore,e.converter,new rL((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,r))}}function lb(e,t,r,n){if(r[0]=(0,h.Ku)(r[0]),r[0]instanceof ld)return function(e,t,r,n,i){if(!n)throw new N(S.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${r}().`);let s=[];for(let r of rq(e))if(r.field.isKeyField())s.push(t8(t,n.key));else{let e=n.data.field(r.field);if(tU(e))throw new N(S.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+r.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=r.field.canonicalString();throw new N(S.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new rl(s,i)}(e._query,e.firestore._databaseId,t,r[0]._document,n);{let i=o4(e.firestore);return function(e,t,r,n,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new N(S.INVALID_ARGUMENT,`Too many arguments provided to ${n}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new N(S.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${n}(), but got a ${typeof l}`);if(!rU(e)&&-1!==l.indexOf("/"))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${n}() must be a plain document ID, but '${l}' contains a slash.`);let r=e.path.child($.fromString(l));if(!Q.isDocumentKey(r))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${n}() must result in a valid document path, but '${r}' is not because it contains an odd number of segments.`);let i=new Q(r);o.push(t8(t,i))}else{let e=lr(r,n,l);o.push(e)}}return new rl(o,s)}(e._query,e.firestore._databaseId,i,t,r,n)}}function l_(e,t,r){if("string"==typeof(r=(0,h.Ku)(r))){if(""===r)throw new N(S.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!rU(t)&&-1!==r.indexOf("/"))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${r}' contains a '/' character.`);let n=t.path.child($.fromString(r));if(!Q.isDocumentKey(n))throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return t8(e,new Q(n))}if(r instanceof oK)return t8(e,r._key);throw new N(S.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${oF(r)}.`)}function lx(e,t){if(!Array.isArray(e)||0===e.length)throw new N(S.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function lS(e,t){let r=function(e,t){for(let r of e)for(let e of r.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==r)throw r===t.op?new N(S.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new N(S.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}class lN{convertValue(e,t="none"){switch(tZ(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tR(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tO(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw x()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return tI(e,(e,n)=>{r[e]=this.convertValue(n,t)}),r}convertVectorValue(e){var t,r,n;return new oJ(null===(n=null===(r=null===(t=e.fields)||void 0===t?void 0:t[tW].arrayValue)||void 0===r?void 0:r.values)||void 0===n?void 0:n.map(e=>tR(e.doubleValue)))}convertGeoPoint(e){return new oZ(tR(e.latitude),tR(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=tq(e);return null==r?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(tB(e));default:return null}}convertTimestamp(e){let t=tV(e);return new q(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=$.fromString(e);ia(r)||x();let n=new t$(r.get(1),r.get(3)),i=new Q(r.popFirst(5));return n.isEqual(t)||E(`Document ${i} contains a document reference within a different database (${n.projectId}/${n.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}class lk extends lN{constructor(e){super(),this.firestore=e}convertBytes(e){return new oH(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new oK(this.firestore,null,t)}}class lD extends ld{constructor(e,t,r,n,i,s){super(e,t,r,n,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new lC(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(lm("DocumentSnapshot.get",e));if(null!==r)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}}class lC extends lD{data(e={}){return super.data(e)}}function lA(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new N(S.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}new WeakMap,function(e=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(t,{instanceIdentifier:r,options:n})=>{let i=t.getProvider("app").getImmediate(),s=new oj(new V(t.getProvider("auth-internal")),new L(i,t.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new N(S.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new t$(e.options.projectId,t)}(i,r),i);return n=Object.assign({useFetchStreams:e},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2017")}()}}]);